<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Catalogs</title>
    <link rel="icon" type="image/x-icon" href="images/SIMPLE_LOGO.png">
    <!-- External CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Shared styles -->
    <link href="shared-styles.css" rel="stylesheet">
    <style>
        /* Additional inline styles for form controls */
        .content-item, .requirement-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
        }

        .content-item input, .requirement-item input {
            flex: 1;
            margin-bottom: 0;
            margin-right: 10px;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 20px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Loading state */
        .loading-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            text-align: center;
            padding: 20px;
            background-color: #f8d7da;
            color: #721c24;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <img src="images/LOGO.png" alt="Logo">
            </div>
            <div class="header-icons">
                <div class="contact-icon">
                    <a href="contacts.html">
                        <img src="images/contact-icon.png" alt="Contact Directory">
                    </a>
                </div>
            </div>
        </div>

        <a href="index.html" class="back-link">‚Üê Back to the Request Form</a>
        
        <!-- Under Construction Banner -->
        <div class="under-construction-banner">
            <div class="construction-icon">üöß</div>
            <div class="construction-message">
                <h2>Page Under Construction</h2>
                <p>We're currently updating our training materials database. Some content may be incomplete or subject to change.</p>
            </div>
        </div>
        <h1>Training Catalogs</h1>
        <p>Browse our comprehensive training programs for PV and BESS systems. Filter by system type, knowledge level, or model to find the right course for your needs.</p>
        
        <!-- Resource Links -->
        <div class="resource-links">
            <a href="https://sungrowdobrasil.com/" target="_blank" class="resource-link">
                <img src="images/brazil-flag.png" alt="Brazil Flag" class="link-icon">
                <span>SUNGROW Academy (Portuguese)</span>
            </a>
            <a href="https://support.sungrowpower.com/home" target="_blank" class="resource-link">
                <img src="images/resource-icon.png" alt="Resource Center" class="link-icon">
                <span>SUNGROW Resource Center</span>
            </a>
        </div>
        <!-- Filter Section -->
        <div class="filter-controls">
            <div class="filter-title">
                Filter by:
                <div class="admin-controls">
                    <button id="admin-button" class="admin-button" title="Add new training course">+</button>
                </div>
            </div>
            <div class="filter-section">
                <div class="filter-label">System Type:</div>
                <div class="filter-row">
                    <div class="filter-item active" data-filter="system" data-value="all">All Systems</div>
                    <div class="filter-item" data-filter="system" data-value="pv">PV Systems</div>
                    <div class="filter-item" data-filter="system" data-value="bess">BESS Systems</div>
                    <div class="filter-item" data-filter="system" data-value="other">Other</div>
                </div>
            </div>
            <div class="filter-section">
                <div class="filter-label">Knowledge Level:</div>
                <div class="filter-row">
                    <div class="filter-item active" data-filter="level" data-value="all">All Levels</div>
                    <div class="filter-item" data-filter="level" data-value="l1">Level 1</div>
                    <div class="filter-item" data-filter="level" data-value="l2">Level 2</div>
                    <div class="filter-item" data-filter="level" data-value="l3">Level 3 (Certification)</div>
                </div>
            </div>
            <div class="filter-section">
                <div class="filter-label">Model:</div>
                <div class="filter-row" id="model-filters">
                    <div class="filter-item active" data-filter="model" data-value="all">All Models</div>
                    <!-- Model filters will be dynamically added here based on available data -->
                </div>
            </div>
        </div>
        <!-- Admin Form Container -->
        <div id="admin-form-container" class="admin-form-container">
            <div class="admin-form-title">Add New Training Course</div>
            <form id="admin-form" class="admin-form">
                <div class="form-field">
                    <label for="training-name">Course Name*</label>
                    <input type="text" id="training-name" name="name" required>
                </div>
                <div class="form-field">
                    <label for="training-system">System Type*</label>
                    <select id="training-system" name="system" required>
                        <option value="">Select System Type</option>
                        <option value="pv">PV Systems</option>
                        <option value="bess">BESS Systems</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="training-level">Knowledge Level*</label>
                    <select id="training-level" name="level" required>
                        <option value="">Select Knowledge Level</option>
                        <option value="L1">Level 1</option>
                        <option value="L2">Level 2</option>
                        <option value="L3">Level 3 (Certification)</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="training-model">Model*</label>
                    <input type="text" id="training-model" name="model" required>
                </div>
                <div class="form-field">
                    <label for="training-duration">Duration*</label>
                    <input type="text" id="training-duration" name="duration" required placeholder="e.g., 1 full day">
                </div>
                
                <div class="admin-form-section">
                    <label>Course Content*</label>
                    <div id="content-container">
                        <div class="content-item">
                            <input type="text" name="content[]" class="form-control" required>
                            <button type="button" class="btn btn-danger remove-content">√ó</button>
                        </div>
                        <div class="content-item">
                            <input type="text" name="content[]" class="form-control" required>
                            <button type="button" class="btn btn-danger remove-content">√ó</button>
                        </div>
                    </div>
                    <button type="button" id="add-content-btn" class="btn btn-success">+ Add Content Item</button>
                </div>
                
                <div class="admin-form-section">
                    <label>Requirements*</label>
                    <div id="requirements-container">
                        <div class="requirement-item">
                            <input type="text" name="requirements[]" class="form-control" required>
                            <button type="button" class="btn btn-danger remove-requirement">√ó</button>
                        </div>
                    </div>
                    <button type="button" id="add-requirement-btn" class="btn btn-success">+ Add Requirement</button>
                </div>
                
                <div class="admin-form-actions">
                    <button type="button" id="cancel-button" class="cancel-button">Cancel</button>
                    <button type="submit" class="submit-button">Add Training</button>
                </div>
            </form>
        </div>
                
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="loading-state">
            <div class="spinner"></div>
            <p>Loading training courses...</p>
        </div>
        
        <!-- Training Materials Grid -->
        <div id="training-grid" class="training-grid">
            <!-- Cards will be dynamically inserted here -->
        </div>
        
        <!-- Empty State (shown when no courses match filters) -->
        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üìö</div>
            <div class="empty-state-heading">No courses found</div>
            <div class="empty-state-text">Try adjusting your filters to see more results.</div>
        </div>
        <!-- Footer -->
        <div class="footer">
            <div class="footer-text">
                <div class="footer-copyright">¬© 2025 CoE LATAM, Sungrow Americas. All Rights Reserved.</div>
                <div class="footer-creator">Created by Andres Provero</div>
            </div>
            <div class="footer-logo">
                <img src="images/COE_LOGO.png" alt="CoE LATAM Logo">
            </div>
        </div>
    </div>
    
    <!-- Training Page JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            const trainingGrid = document.getElementById('training-grid');
            const emptyState = document.getElementById('empty-state');
            const loadingIndicator = document.getElementById('loading-indicator');
            const modelFiltersContainer = document.getElementById('model-filters');
            const adminButton = document.getElementById('admin-button');
            const adminFormContainer = document.getElementById('admin-form-container');
            const adminForm = document.getElementById('admin-form');
            const cancelButton = document.getElementById('cancel-button');
            const addContentBtn = document.getElementById('add-content-btn');
            const addRequirementBtn = document.getElementById('add-requirement-btn');
            const contentContainer = document.getElementById('content-container');
            const requirementsContainer = document.getElementById('requirements-container');
            
            // Track active filters
            const activeFilters = {
                system: 'all',
                level: 'all',
                model: 'all'
            };
            
            // Store all training data
            let allTrainings = [];
            
            // Base API URL - Corrected to use the proper endpoint
            const apiBaseUrl = 'https://level3support.onrender.com/api/trainings';
            
            // Admin form toggle
            adminButton.addEventListener('click', function() {
                adminFormContainer.classList.toggle('visible');
            });
            
            cancelButton.addEventListener('click', function() {
                adminFormContainer.classList.remove('visible');
                adminForm.reset();
                resetFormItems();
            });
            
            // Add content item
            addContentBtn.addEventListener('click', function() {
                const newItem = document.createElement('div');
                newItem.className = 'content-item';
                newItem.innerHTML = `
                    <input type="text" name="content[]" class="form-control" required>
                    <button type="button" class="btn btn-danger remove-content">√ó</button>
                `;
                contentContainer.appendChild(newItem);
            });
            
            // Add requirement item
            addRequirementBtn.addEventListener('click', function() {
                const newItem = document.createElement('div');
                newItem.className = 'requirement-item';
                newItem.innerHTML = `
                    <input type="text" name="requirements[]" class="form-control" required>
                    <button type="button" class="btn btn-danger remove-requirement">√ó</button>
                `;
                requirementsContainer.appendChild(newItem);
            });
            // Remove content item
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-content')) {
                    const item = e.target.closest('.content-item');
                    if (contentContainer.children.length > 1) {
                        contentContainer.removeChild(item);
                    }
                }
                
                if (e.target.classList.contains('remove-requirement')) {
                    const item = e.target.closest('.requirement-item');
                    if (requirementsContainer.children.length > 1) {
                        requirementsContainer.removeChild(item);
                    }
                }
            });
            
            // Reset form items
            function resetFormItems() {
                contentContainer.innerHTML = `
                    <div class="content-item">
                        <input type="text" name="content[]" class="form-control" required>
                        <button type="button" class="btn btn-danger remove-content">√ó</button>
                    </div>
                    <div class="content-item">
                        <input type="text" name="content[]" class="form-control" required>
                        <button type="button" class="btn btn-danger remove-content">√ó</button>
                    </div>
                `;
                
                requirementsContainer.innerHTML = `
                    <div class="requirement-item">
                        <input type="text" name="requirements[]" class="form-control" required>
                        <button type="button" class="btn btn-danger remove-requirement">√ó</button>
                    </div>
                `;
            }
            
            // Handle form submission
            adminForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show loading state
                const submitBtn = adminForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Adding...';
                submitBtn.disabled = true;
                
                // Collect form data
                const formData = new FormData(adminForm);
                
                // Convert to JSON object
                const jsonData = {
                    name: formData.get('name'),
                    system: formData.get('system'),
                    level: formData.get('level'),
                    model: formData.get('model'),
                    duration: formData.get('duration'),
                    content: Array.from(formData.getAll('content[]')).filter(item => item.trim() !== ''),
                    requirements: Array.from(formData.getAll('requirements[]')).filter(item => item.trim() !== '')
                };
                
                // Send data to server - corrected endpoint
                fetch(apiBaseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server error: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Reset form and hide it
                        adminForm.reset();
                        resetFormItems();
                        adminFormContainer.classList.remove('visible');
                        
                        // Reload training data
                        fetchTrainingData();
                        
                        // Show success message
                        alert('Training course added successfully!');
                    } else {
                        alert('Error: ' + (data.message || 'Failed to add training course'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to add training course. Please try again.');
                })
                .finally(() => {
                    // Reset button state
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
            });
            
            // Fetch training data from server
            function fetchTrainingData() {
                // Show loading indicator
                loadingIndicator.style.display = 'flex';
                trainingGrid.style.display = 'none';
                emptyState.style.display = 'none';
                
                // Fetch data with retry capability - corrected endpoint
                fetchWithRetry(apiBaseUrl, 3)
                    .then(data => {
                        console.log('Received data:', data); // Debug log
                        if (data.success && data.trainings) {
                            // Store all trainings for later filtering
                            allTrainings = data.trainings;
                            // Apply current filters
                            applyFilters();
                            // Setup model filters based on all data
                            setupModelFilters(allTrainings);
                        } else {
                            console.error('Error fetching training data:', data.message || 'Unknown error');
                            trainingGrid.innerHTML = '<div class="error-message">Failed to load training data. Please refresh the page or try again later.</div>';
                            trainingGrid.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        trainingGrid.innerHTML = '<div class="error-message">Failed to load training data. Please refresh the page or try again later.</div>';
                        trainingGrid.style.display = 'block';
                    })
                    .finally(() => {
                        loadingIndicator.style.display = 'none';
                    });
            }
            
            // Apply filters to training data
            function applyFilters() {
                // Apply filters to training data
                const filteredTrainings = allTrainings.filter(item => {
                    const matchesSystem = activeFilters.system === 'all' || item.system === activeFilters.system;
                    const matchesLevel = activeFilters.level === 'all' || item.level.toLowerCase() === activeFilters.level;
                    const matchesModel = activeFilters.model === 'all' || item.model === activeFilters.model;
                    
                    return matchesSystem && matchesLevel && matchesModel;
                });
                
                // Render the filtered data
                renderTrainingData(filteredTrainings);
            }
            
            // Fetch with retry functionality
            function fetchWithRetry(url, maxRetries) {
                return new Promise((resolve, reject) => {
                    const attemptFetch = (retriesLeft) => {
                        fetch(url)
                            .then(response => {
                                console.log('Response status:', response.status); // Debug log
                                if (!response.ok) {
                                    throw new Error('Server error: ' + response.status);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Parsed data:', data); // Debug log
                                resolve(data);
                            })
                            .catch(error => {
                                console.error('Fetch attempt error:', error); // Debug log
                                if (retriesLeft > 0) {
                                    console.log(`Retrying... ${retriesLeft} attempts left`); // Debug log
                                    // Wait 1 second before retrying
                                    setTimeout(() => attemptFetch(retriesLeft - 1), 1000);
                                } else {
                                    reject(error);
                                }
                            });
                    };
                    
                    attemptFetch(maxRetries);
                });
            }
            
            // Render training data as cards
            function renderTrainingData(trainings) {
                // Clear the grid
                trainingGrid.innerHTML = '';
                
                // Show empty state if no results
                if (trainings.length === 0) {
                    emptyState.style.display = 'block';
                    trainingGrid.style.display = 'none';
                    return;
                } else {
                    emptyState.style.display = 'none';
                    trainingGrid.style.display = 'grid';
                }
                
                // Create card for each training item
                trainings.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'training-card';
                    card.setAttribute('data-id', item.id);
                    card.setAttribute('data-system', item.system);
                    card.setAttribute('data-level', item.level.toLowerCase());
                    card.setAttribute('data-model', item.model);
                    
                    // Create card HTML
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-system-tag system-${item.system}">[${item.system.toUpperCase()}]</div>
                            <div class="card-title">${item.name}</div>
                            <div class="card-level">${item.levelText || getLevelText(item.level)}</div>
                            <div class="card-duration">Duration: ${item.duration}</div>
                        </div>
                        <div class="card-content">
                            <button class="view-details-btn" data-id="${item.id}">VIEW DETAILS</button>
                            <div class="card-details" id="details-${item.id}">
                                <h4>Covers:</h4>
                                <ul class="content-list">
                                    ${Array.isArray(item.content) ? item.content.map(point => `<li>${point}</li>`).join('') : ''}
                                </ul>
                                <h4>Requirements:</h4>
                                <ul class="requirements-list">
                                    ${Array.isArray(item.requirements) ? item.requirements.map(req => `<li>${req}</li>`).join('') : ''}
                                </ul>
                                <button class="hide-details-btn" data-id="${item.id}">HIDE DETAILS</button>
                            </div>
                        </div>
                    `;
                    
                    // Add card to grid
                    trainingGrid.appendChild(card);
                });
                
                // Add click handlers for view/hide buttons
                setupDetailButtons();
            }
            
            // Helper function to get level text
            function getLevelText(level) {
                switch(level.toLowerCase()) {
                    case 'l1': return 'Level 1';
                    case 'l2': return 'Level 2';
                    case 'l3': return 'Level 3 (Certification)';
                    default: return level;
                }
            }
            
            // Set up model filters based on available data
            function setupModelFilters(trainings) {
                // Get unique models
                const uniqueModels = [...new Set(trainings.map(item => item.model))].sort();
                
                // Clear existing model filters (except "All Models")
                const allModelsFilter = modelFiltersContainer.querySelector('[data-value="all"]');
                modelFiltersContainer.innerHTML = '';
                modelFiltersContainer.appendChild(allModelsFilter);
                
                // Add model filters
                uniqueModels.forEach(model => {
                    if (model && model.trim() !== '') {
                        const filterItem = document.createElement('div');
                        filterItem.className = 'filter-item';
                        filterItem.setAttribute('data-filter', 'model');
                        filterItem.setAttribute('data-value', model);
                        filterItem.textContent = model;
                        modelFiltersContainer.appendChild(filterItem);
                    }
                });
                
                // Reattach filter click handlers
                setupFilters();
            }
            
            // Set up filter functionality
            function setupFilters() {
                const filterItems = document.querySelectorAll('.filter-item');
                
                filterItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const filterType = this.getAttribute('data-filter');
                        const filterValue = this.getAttribute('data-value');
                        
                        // Update active filter
                        activeFilters[filterType] = filterValue;
                        
                        // Update active class
                        document.querySelectorAll(`.filter-item[data-filter="${filterType}"]`).forEach(el => {
                            el.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // Apply filters without fetching data again
                        applyFilters();
                    });
                });
            }
            
            // Set up detail view/hide buttons
            function setupDetailButtons() {
                document.querySelectorAll('.view-details-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        
                        // Show details
                        const detailsSection = document.getElementById(`details-${id}`);
                        detailsSection.style.display = 'block';
                        
                        // Hide view button
                        this.style.display = 'none';
                        
                        // Show hide button
                        const hideButton = document.querySelector(`.hide-details-btn[data-id="${id}"]`);
                        hideButton.style.display = 'block';
                    });
                });
                
                document.querySelectorAll('.hide-details-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        
                        // Hide details
                        const detailsSection = document.getElementById(`details-${id}`);
                        detailsSection.style.display = 'none';
                        
                        // Show view button
                        const viewButton = document.querySelector(`.view-details-btn[data-id="${id}"]`);
                        viewButton.style.display = 'block';
                        
                        // Hide hide button
                        this.style.display = 'none';
                    });
                });
            }
            
            // Initialize the page
            fetchTrainingData();
        });
    </script>
</body>
</html>