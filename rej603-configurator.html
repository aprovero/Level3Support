<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoE Level 3 - REJ603 DIP Switch Configurator</title>
    <link rel="icon" type="image/x-icon" href="images/SIMPLE_LOGO.png">
    <!-- External CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

    <!-- Portal frame styles from your shared CSS -->
    <link href="css/shared-styles.css" rel="stylesheet">

    <!-- Configurator specific styles -->
    <link href="css/rej603-configurator.css" rel="stylesheet">
    
    <!-- Essential Portal Frame Styles - Inline to ensure they load -->
    <style>
        /* Portal Frame Styles */
        body {
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }
        
        .container {
            max-width: 720px;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 10px;
            position: relative;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0 20px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo img {
            height: 60px;
            width: auto;
        }
        
        .abb-logo {
            display: flex;
            align-items: center;
        }
        
        .abb-logo img {
            height: 60px;
            width: auto;
        }
        
        .footer {
            padding: 20px 30px;
            margin-top: 40px;
            border-top: 1px solid #eee;
            color: #999999;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .footer-text {
            text-align: left;
        }
        
        .footer-copyright {
            color: #999999;
            margin-bottom: 5px;
        }
        
        .footer-creator {
            color: #999999;
            font-size: 13px;
        }
        
        .footer-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .footer-logo img {
            height: 40px;
            width: auto;
        }
        
        .footer-logo img[alt="Claude Logo"] {
            height: 28px;
            width: auto;
        }
        
        .footer-logo img[alt="CoE LATAM Logo"] {
            height: 40px;
        }
        
        /* Mobile responsiveness for portal frame */
        @media (max-width: 768px) {
            .container {
                margin: 10px auto;
                padding: 12px;
                width: 92%;
            }
            
            .header {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 15px;
            }
            
            .logo img, .abb-logo img {
                height: 50px;
            }
            
            .footer {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .footer-text {
                text-align: center;
                margin-bottom: 10px;
            }
            
            .footer-logo {
                margin-top: 10px;
            }
            
            .footer-copyright,
            .footer-creator {
                font-size: 12px;
            }
        }
    </style>
    
    <!-- Original DIP Switch Configurator Styles - EXACTLY as they were -->
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
        }
        
        .configurator-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .configurator-title {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: clamp(20px, 5vw, 24px);
        }
        
        @media (min-width: 768px) {
            .configurator-content {
                padding: 30px;
            }
            
            .configurator-title {
                margin-bottom: 30px;
            }
        }
        
        .mode-selector {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #1976d2;
        }
        
        .mode-selector h2 {
            margin: 0 0 10px 0;
            color: #1976d2;
            font-size: 18px;
        }
        
        .mode-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .mode-button {
            padding: 10px 20px;
            border: 2px solid #1976d2;
            background-color: white;
            color: #1976d2;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .mode-button.active {
            background-color: #1976d2;
            color: white;
        }
        
        .mode-button:hover {
            background-color: #1976d2;
            color: white;
        }
        
        .input-section {
            background-color: #fafafa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .input-section h2 {
            color: #444;
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-section label {
            display: block;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        
        .input-section input[type="number"], .input-section select {
            width: 100%;
            padding: 8px;
            border: 1px solid #666;
            border-radius: 3px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .switch-reference {
            color: #666;
            font-size: 12px;
            font-weight: normal;
            margin-top: 2px;
            margin-bottom: 8px;
            font-style: italic;
        }
        
        .input-section input[type="number"] {
            max-width: 250px;
            width: 100%;
        }
        
        .input-section select {
            max-width: 250px;
        }
        
        @media (min-width: 768px) {
            .input-section label {
                display: inline-block;
                min-width: 200px;
            }
            
            .input-section input[type="number"], .input-section select {
                width: auto;
            }
        }
        
        .switch-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 20px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        @media (max-width: 480px) {
            .switch-display {
                gap: 5px;
                padding: 5px;
            }
        }
        
        .switch-block-container {
            border: 2px solid #d32f2f;
            border-radius: 6px;
            overflow: hidden;
            background-color: #666;
            min-width: 0;
            width: 100%;
        }
        
        @media (max-width: 480px) {
            .switch-block-container {
                border-width: 1px;
                border-radius: 4px;
            }
        }
        
        .switch-label {
            background-color: #d32f2f;
            color: white;
            padding: 5px;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }
        
        .switch-info {
            background-color: #ffffff;
            padding: 6px;
            font-size: 15px;
            color: #333;
            text-align: left;
            height: 85px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            line-height: 1.0;
            overflow-y: auto;
        }
        
        .switch-info strong {
            color: #d32f2f;
            font-size: 14px;
            margin: 0 0 1px 0;
            display: block;
            line-height: 1.0;
        }
        
        .switch-info small {
            color: #666;
            font-size: 13px;
            font-style: italic;
            margin: 0;
            line-height: 1.0;
        }
        
        .switch-info .section-break {
            margin: 0;
            padding: 0;
        }
        
        .switch-info .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin: 1px 0;
        }
        
        .switch-info .column-item {
            margin: 0;
            line-height: 1.0;
            font-size: 14px;
        }
        
        .switch-info .compact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            margin: 1px 0;
        }
        
        .switch-info .compact-item {
            margin: 0;
            line-height: 0.9;
            font-size: 13px;
        }
        
        @media (min-width: 480px) {
            .switch-label {
                padding: 8px;
                font-size: 16px;
            }
            
            .switch-info {
                padding: 8px;
                font-size: 11px;
                min-height: 50px;
            }
        }
        
        .dip-switch-bank {
            background-color: #333;
            padding: 10px 5px 15px 12px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0;
            position: relative;
            overflow-x: hidden;
            margin-left: 0;
        }
        
        .dip-switch {
            width: auto;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 1px;
            position: relative;
            margin-bottom: 0;
        }
        
        .switch-number {
            font-size: 11px;
            font-weight: bold;
            width: 10px;
            color: white;
            text-align: center;
            flex-shrink: 0;
            margin-right: 2px;
        }
        
        .switch-label-text {
            font-size: 8px;
            color: #999;
            white-space: nowrap;
            width: 20px;
            text-align: right;
            margin-right: 2px;
            flex-shrink: 0;
        }
        
        .switch-slider {
            width: 48px;
            height: 16px;
            background-color: #666;
            border: 1px solid #999;
            border-radius: 2px;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            margin-left: 1px;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .switch-slider:hover {
            border-color: #fff;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3), 0 0 5px rgba(255,255,255,0.3);
        }
        
        @media (min-width: 480px) {
            .dip-switch-bank {
                padding: 15px 8px 15px 15px;
                gap: 3px;
            }
            
            .dip-switch {
                height: 20px;
                padding: 0 5px;
                margin-bottom: 0;
            }
            
            .switch-number {
                font-size: 12px;
                width: 18px;
                margin-right: 5px;
            }
            
            .switch-label-text {
                font-size: 10px;
                width: 28px;
                margin-right: 5px;
            }
            
            .switch-slider {
                width: 55px;
                height: 18px;
                margin-left: 3px;
            }
        }
        
        @media (min-width: 768px) {
            .dip-switch-bank {
                padding: 15px 10px;
            }
        }
        
        .switch-label-text {
            font-size: 9px;
            color: #999;
            white-space: nowrap;
            margin-right: 3px;
        }
        
        @media (min-width: 480px) {
            .switch-label-text {
                font-size: 10px;
                margin-right: 5px;
            }
        }
        
        @media (min-width: 768px) {
            .dip-switch-bank {
                padding: 15px 10px 15px 60px;
            }
            
            .switch-label-text {
                font-size: 10px;
            }
        }
        
        .switch-number {
            font-size: 11px;
            font-weight: bold;
            width: 18px;
            color: white;
            text-align: center;
            flex-shrink: 0;
            margin-right: 2px;
            line-height: 1;
        }
        
        .switch-slider {
            width: 45px;
            height: 16px;
            background-color: #666;
            border: 1px solid #999;
            border-radius: 2px;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
            margin-left: 1px;
            flex-shrink: 0;
        }
        
        .switch-toggle {
            position: absolute;
            width: 22px;
            height: 12px;
            background-color: white;
            border: 1px solid #333;
            border-radius: 2px;
            top: 1px;
            transition: left 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        @media (min-width: 480px) {
            .switch-slider {
                width: 55px;
                height: 18px;
            }
            
            .switch-toggle {
                width: 26px;
                height: 14px;
            }
        }
        
        .switch-on .switch-toggle {
            left: 26px;
            background-color: #fff;
        }
        
        .switch-off .switch-toggle {
            left: 1px;
            background-color: #f0f0f0;
        }
        
        .position-labels {
            display: flex;
            justify-content: space-between;
            width: 60px;
            font-size: 10px;
            color: white;
            margin-top: 2px;
        }
        
        .configurator-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }
        
        .configurator-button:hover {
            background-color: #45a049;
        }
        
        .reverse-button {
            background-color: #ff9800;
        }
        
        .reverse-button:hover {
            background-color: #f57c00;
        }
        
        .calculated-values {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
        
        .calculated-values h3 {
            margin-top: 0;
            color: #856404;
            font-size: 16px;
        }
        
        .calculated-values p {
            margin: 5px 0;
            color: #856404;
            font-size: 14px;
        }
        
        .unit {
            color: #666;
            font-weight: normal;
        }
        
        .mode-description {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .configurator-error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border: 1px solid #f5c6cb;
        }

        .configurator-error h3 {
            margin-top: 0;
            color: #721c24;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Portal Header - Using shared styles -->
        <div class="header">
            <div class="logo">
                <img src="images/LOGO.png" alt="Sungrow Logo">
            </div>
            <div class="abb-logo">
                <img src="images/ABB_LOGO.png" alt="ABB Logo">
            </div>
        </div>
        
        <!-- Original DIP Switch Configurator Content -->
        <h1 class="configurator-title">REJ603 Relay DIP Switch Configurator</h1>
        
        <div class="mode-selector">
                <h2>Operation Mode</h2>
                <div class="mode-buttons">
                    <div class="mode-button active" onclick="setMode('configure')">Configure Settings</div>
                    <div class="mode-button" onclick="setMode('reverse')">Reverse Engineer</div>
                </div>
                <div class="mode-description" id="modeDescription">
                    Enter your protection requirements and generate DIP switch positions.
                </div>
            </div>
            
            <div id="configureMode">
                <div class="input-section">
                    <h2>Basic Settings</h2>
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Transformer Current (Is):
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW1 (1-4)
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="transformerCurrent" min="8" max="448" step="1" 
                                   placeholder="8A min - 448A max" 
                                   style="width: 300px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">A</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Earth Fault Measurement (Io>):</label>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="min-width: auto; font-weight: normal;">
                                <input type="radio" name="earthFault" value="internal" checked style="margin-right: 5px;">
                                Internal
                            </label>
                            <label style="min-width: auto; font-weight: normal;">
                                <input type="radio" name="earthFault" value="external" style="margin-right: 5px;">
                                External
                            </label>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>HMI:</label>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="min-width: auto; font-weight: normal;">
                                <input type="radio" name="hmi" value="disabled" checked style="margin-right: 5px;">
                                No (DIP switches only)
                            </label>
                            <label style="min-width: auto; font-weight: normal;">
                                <input type="radio" name="hmi" value="enabled" style="margin-right: 5px;">
                                Yes (DIP + HMI fine)
                            </label>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Frequency (Fn):</label>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="min-width: auto; font-weight: normal;">
                                <input type="radio" name="frequency" value="50Hz" style="margin-right: 5px;">
                                50 Hz
                            </label>
                            <label style="min-width: auto; font-weight: normal;">
                                <input type="radio" name="frequency" value="60Hz" checked style="margin-right: 5px;">
                                60 Hz
                            </label>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Failsafe (Fs):</label>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="min-width: auto; font-weight: normal;">
                                <input type="radio" name="failsafe" value="disabled" style="margin-right: 5px;">
                                Disable
                            </label>
                            <label style="min-width: auto; font-weight: normal;">
                                <input type="radio" name="failsafe" value="enabled" checked style="margin-right: 5px;">
                                Enable
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="input-section">
                    <h2>Phase Overcurrent Protection (50/51)</h2>
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Function 51 - Pickup Current (I>):
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW3 (1-5)
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="phasePickup51" min="0.9" max="2.5" step="0.05" 
                                   placeholder="0.9min - 2.5max" 
                                   style="width: 300px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">√ó In</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Function 51 - Curve Type:
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW3 (6-8)
                        </div>
                        <select id="phaseCurve51" style="width: 320px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <option value="NI" selected>Normal Inverse - balanced compromise for everyday feeder protection</option>
                            <option value="VI">Very Inverse - faster as fault current rises, good for low source impedance</option>
                            <option value="EI">Extremely Inverse - aggressive at high fault levels, coordinates tightly with fuses</option>
                            <option value="LI">Long-time Inverse - slowest curve, protects cables/transformers with thermal limits</option>
                            <option value="RI">RI-type Inverse - legacy reset-inverse shape for easy retrofit of old systems</option>
                            <option value="HR">HR-type Fuse - shaped to match high-rupture fuse characteristics</option>
                            <option value="FR">FR-type Fuse - matches fast-acting fuse profile, quicker at lower fault current</option>
                            <option value="DMT">Definite Minimum Time - flat fixed time, not inverse but preferred for some applications</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Function 51 - Time Constant (t>):
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW2 (1-4)
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="phaseTime51" min="0.05" max="3" step="0.05" 
                                   placeholder="0.05min - 3max" 
                                   style="width: 300px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">s</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Function 50 - Pickup Current (I>>):
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW5 (1-4)
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="phasePickup50" min="1" max="20" step="0.1" 
                                   placeholder="1min - 20max" 
                                   style="width: 300px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">√ó In</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Function 50 - Definite Time (t>>):
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW5 (5-8)
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="phaseTime50" min="0.04" max="3" step="0.01" 
                                   placeholder="0.04min - 3max" 
                                   style="width: 300px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">s</span>
                        </div>
                    </div>
                </div>
                
                <div class="input-section">
                    <h2>Earth Fault Protection (50N/51N)</h2>
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Function 51N - Pickup Current (Io>):
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW4 (1-5)
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="earthPickup51N" min="0.1" max="1.0" step="0.025" 
                                   placeholder="0.1min - 1.0max" 
                                   style="width: 300px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">√ó Is</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Function 51N - Curve Type:
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW4 (6-8)
                        </div>
                        <select id="earthCurve51N" style="width: 320px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <option value="NI" selected>Normal Inverse - balanced compromise for everyday feeder protection</option>
                            <option value="VI">Very Inverse - faster as fault current rises, good for low source impedance</option>
                            <option value="EI">Extremely Inverse - aggressive at high fault levels, coordinates tightly with fuses</option>
                            <option value="LI">Long-time Inverse - slowest curve, protects cables/transformers with thermal limits</option>
                            <option value="RI">RI-type Inverse - legacy reset-inverse shape for easy retrofit of old systems</option>
                            <option value="HR">HR-type Fuse - shaped to match high-rupture fuse characteristics</option>
                            <option value="FR">FR-type Fuse - matches fast-acting fuse profile, quicker at lower fault current</option>
                            <option value="DMT">Definite Minimum Time - flat fixed time, not inverse but preferred for some applications</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Function 51N - Time Constant (to>):
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW2 (5-8)
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="earthTime51N" min="0.05" max="3" step="0.05" 
                                   placeholder="0.05min - 3max" 
                                   style="width: 300px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">s</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Function 50N - Pickup Current (Io>>):
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW6 (1-4)
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="earthPickup50N" min="1" max="20" step="0.01" 
                                   placeholder="1min - 20max" 
                                   style="width: 300px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">√ó Is</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #333; font-size: 14px; margin-bottom: 3px;">
                            Function 50N - Definite Time (to>>):
                        </div>
                        <div style="color: #666; font-size: 12px; font-style: italic; margin-bottom: 8px;">
                            SW6 (5-8)
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="earthTime50N" min="0.04" max="3" step="0.01" 
                                   placeholder="0.04min - 3max" 
                                   style="width: 300px; padding: 8px; border: 1px solid #666; border-radius: 3px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">s</span>
                        </div>
                    </div>
                </div>
                
                <button class="configurator-button" onclick="calculateDipSwitches()">Calculate DIP Switch Configuration</button>
            </div>
            
            <div id="reverseMode" style="display: none;">
                <div class="input-section">
                    <h2>Reverse Engineering Instructions</h2>
                    <p>üëâ <strong>Click on each DIP switch below to match the physical relay configuration.</strong></p>
                    <p>üîç The app will automatically decode and display the protection settings.</p>
                    <p>üìã Use this to document existing installations or troubleshoot unexpected behavior.</p>
                </div>
            </div>
            
            <div id="errorDisplay" style="display: none;" class="configurator-error">
                <h3>‚ö†Ô∏è Configuration Error</h3>
                <div id="errorMessage"></div>
            </div>
            
            <div id="results" style="display: none;">
                <div id="calculatedValues" class="calculated-values" style="margin-top: 20px;"></div>
                
                <div class="switch-display">
                    <div class="switch-block-container">
                        <div class="switch-label">S1</div>
                        <div class="switch-info" id="s1-info">Is = 112A</div>
                        <div id="switchS1" class="dip-switch-bank"></div>
                    </div>
                    
                    <div class="switch-block-container">
                        <div class="switch-label">S3</div>
                        <div class="switch-info" id="s3-info">Pickup 51F<br>112A √ó 1.2</div>
                        <div id="switchS3" class="dip-switch-bank"></div>
                    </div>
                    
                    <div class="switch-block-container">
                        <div class="switch-label">S5</div>
                        <div class="switch-info" id="s5-info">Pickup 50F<br>I>></div>
                        <div id="switchS5" class="dip-switch-bank"></div>
                    </div>
                    
                    <div class="switch-block-container">
                        <div class="switch-label">S2</div>
                        <div class="switch-info" id="s2-info">Time dial 51F<br>t>/k = 0.4</div>
                        <div id="switchS2" class="dip-switch-bank"></div>
                    </div>
                    
                    <div class="switch-block-container">
                        <div class="switch-label">S4</div>
                        <div class="switch-info" id="s4-info">Pickup 51G<br>Io></div>
                        <div id="switchS4" class="dip-switch-bank"></div>
                    </div>
                    
                    <div class="switch-block-container">
                        <div class="switch-label">S6</div>
                        <div class="switch-info" id="s6-info">Pickup 50G<br>Io>></div>
                        <div id="switchS6" class="dip-switch-bank"></div>
                    </div>
                </div>
                
                <div id="reverseDecodeButton" style="display: none; margin-top: 20px;">
                    <button class="reverse-button configurator-button" onclick="reverseEngineerConfiguration()" style="width: 100%;">üîç Decode Current DIP Configuration</button>
                </div>
            </div>
        
        <!-- Portal Footer -->
        <footer class="footer">
            <div class="footer-text">
                <div class="footer-copyright">¬© 2025 CoE LATAM, Sungrow Americas. All Rights Reserved.</div>
                <div class="footer-creator">Created by Andres Provero</div>
            </div>
            <div class="footer-logo">
                <a href="https://www.anthropic.com" target="_blank">
                    <img src="images/CLAUDE_LOGO.png" alt="Claude Logo">
                </a>
                <img src="images/COE_LOGO.png" alt="CoE LATAM Logo">
            </div>
        </footer>
    </div>

    <!-- Original JavaScript - EXACTLY as it was -->
    <script>
        // Global state
        let currentMode = 'configure';
        let switches = {
            S1: [0,0,0,0,0,0,0,0],
            S2: [0,0,0,0,0,0,0,0],
            S3: [0,0,0,0,0,0,0,0],
            S4: [0,0,0,0,0,0,0,0],
            S5: [0,0,0,0,0,0,0,0],
            S6: [0,0,0,0,0,0,0,0]
        };
        
        // Protection Engineer's Guide to REJ603 DIP Switch Configuration
        // This configurator implements the constraint-based selection algorithm that real protection engineers use
        
        // STEP 1: Define the CT ranges and their current capacities
        // Each CT range not only handles different currents, but provides access to different protection setting ranges
        const ctRanges = {
            CT1: { min: 8, max: 28, values: [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 20, 22, 24, 26, 28] },
            CT2: { min: 16, max: 56, values: [16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 40, 44, 48, 52, 56] },
            CT3: { min: 32, max: 112, values: [32, 36, 40, 44, 48, 52, 56, 60, 64, 68, 72, 80, 88, 96, 104, 112] },
            CT4: { min: 64, max: 224, values: [64, 72, 80, 88, 96, 104, 112, 120, 128, 136, 144, 160, 176, 192, 208, 224] },
            CT5: { min: 128, max: 448, values: [128, 144, 160, 176, 192, 208, 224, 240, 256, 272, 288, 320, 352, 384, 416, 448] }
        };
        
        // STEP 2: Define the two-tier protection setting ranges
        // This is the key insight - each protection function has two distinct setting ranges
        // The engineer must choose which range they need access to, which then constrains CT selection
        
        // Phase Overcurrent Settings (I>) - S3/1-5
        const phaseCurrentSettings = {
            firstRow:  [0.9, 0.95, 1, 1.05, 1.1, 1.15, 1.2, 1.25, 1.3, 1.35, 1.4, 1.45, 1.5, 1.55, 1.6, 1.65],
            secondRow: [1.7, 1.75, 1.8, 1.85, 1.9, 1.95, 2, 2.05, 2.1, 2.15, 2.2, 2.25, 2.3, 2.4, 2.5, 'E']
        };
        
        // Earth Fault Settings (Io>) - S4/1-5  
        const earthCurrentSettings = {
            firstRow:  [0.1, 0.125, 0.15, 0.175, 0.2, 0.225, 0.25, 0.275, 0.3, 0.325, 0.35, 0.375, 0.4, 0.425, 0.45, 0.475],
            secondRow: [0.5, 0.525, 0.575, 0.6, 0.625, 0.65, 0.675, 0.7, 0.725, 0.75, 0.8, 0.85, 0.9, 0.95, 1, 'E']
        };
        
        // Time Settings (same for both phase and earth) - S2/1-4 and S2/5-8
        const timeSettings = [0.05, 0.07, 0.1, 0.15, 0.2, 0.25, 0.3, 0.4, 0.6, 0.8, 1, 1.4, 1.8, 2.2, 2.6, 3];
        
        // High-set Settings - S5/1-4 and S6/1-4
        const highsetCurrentSettings = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 12, 14, 16, 18, 20, 'E'];
        const highsetTimeSettings = [0.04, 0.07, 0.1, 0.15, 0.2, 0.25, 0.3, 0.4, 0.6, 0.8, 1, 1.4, 1.8, 2.2, 2.6, 3];
        
        // Characteristic Curve Settings - S3/6-8 and S4/6-8
        const characteristicSettings = ['DMT', 'NI', 'EI', 'VI', 'LI', 'RI', 'HR', 'FR'];
        
        // STEP 3: Define the binary DIP switch patterns
        // These patterns correspond to positions 1-16 in each setting range
        // Pattern source: REJ603 relay documentation DIP switch truth table
        const binaryPatterns = [
            [0,0,0,0], [1,0,0,0], [0,1,0,0], [1,1,0,0], [0,0,1,0], [1,0,1,0], [0,1,1,0], [1,1,1,0],
            [0,0,0,1], [1,0,0,1], [0,1,0,1], [1,1,0,1], [0,0,1,1], [1,0,1,1], [0,1,1,1], [1,1,1,1]
        ];
        
        // Mode switching
        function setMode(mode) {
            currentMode = mode;
            
            // Update button states
            document.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide appropriate sections
            const configMode = document.getElementById('configureMode');
            const reverseMode = document.getElementById('reverseMode');
            const results = document.getElementById('results');
            const errorDisplay = document.getElementById('errorDisplay');
            const modeDescription = document.getElementById('modeDescription');
            
            if (mode === 'configure') {
                configMode.style.display = 'block';
                reverseMode.style.display = 'none';
                document.getElementById('reverseDecodeButton').style.display = 'none';
                modeDescription.innerHTML = 'Enter your protection requirements and generate DIP switch positions.';
            } else {
                configMode.style.display = 'none';
                reverseMode.style.display = 'block';
                results.style.display = 'block'; // Show switches for manipulation
                errorDisplay.style.display = 'none';
                document.getElementById('reverseDecodeButton').style.display = 'block';
                modeDescription.innerHTML = 'Click DIP switches to match physical relay, then decode to see protection settings.';
                
                // Initialize empty switches for reverse engineering
                resetSwitches();
                displayEmptySwitches();
            }
        }
        
        function resetSwitches() {
            switches = {
                S1: [0,0,0,0,0,0,0,0],
                S2: [0,0,0,0,0,0,0,0],
                S3: [0,0,0,0,0,0,0,0],
                S4: [0,0,0,0,0,0,0,0],
                S5: [0,0,0,0,0,0,0,0],
                S6: [0,0,0,0,0,0,0,0]
            };
        }
        
        // STEP 4: THE CORE ENGINEERING LOGIC - Overlap Zone CT Selection
        // This function implements the real protection engineer's decision process:
        // "Which CT ranges can handle my current?" ‚Üí "If multiple options exist (overlap zone), choose based on row access needed"
        
        function determineRequiredCTConfiguration(transformerCurrent, phasePickup, earthPickup) {
            // CRITICAL CONSTRAINT: Both phase and earth protection must use the same row
            // This is a fundamental relay system requirement that prevents internal conflicts
            
            // Analyze which row each protection function requires
            const phaseInFirstRow = phaseCurrentSettings.firstRow.includes(phasePickup);
            const phaseInSecondRow = phaseCurrentSettings.secondRow.includes(phasePickup);
            const earthInFirstRow = earthCurrentSettings.firstRow.includes(earthPickup);
            const earthInSecondRow = earthCurrentSettings.secondRow.includes(earthPickup);
            
            // Validate that each setting exists in at least one row
            if (!phaseInFirstRow && !phaseInSecondRow) {
                throw new Error(`Phase pickup setting ${phasePickup} is not available in any setting range. Please choose a value between 0.9-1.65 or 1.7-2.5.`);
            }
            
            if (!earthInFirstRow && !earthInSecondRow) {
                throw new Error(`Earth pickup setting ${earthPickup} is not available in any setting range. Please choose a value between 0.1-0.475 or 0.5-1.0.`);
            }
            
            // Determine which row configurations are possible
            const canUseBothInFirstRow = phaseInFirstRow && earthInFirstRow;
            const canUseBothInSecondRow = phaseInSecondRow && earthInSecondRow;
            
            // CRITICAL VALIDATION: Both functions must be able to use the same row
            if (!canUseBothInFirstRow && !canUseBothInSecondRow) {
                throw new Error(`Configuration Error: Phase protection (I> = ${phasePickup}) and Earth protection (Io> = ${earthPickup}) require different setting rows and cannot be used together.\n\nPhase I> = ${phasePickup} is available in: ${phaseInFirstRow ? 'First Row (0.9-1.65)' : ''} ${phaseInSecondRow ? 'Second Row (1.7-2.5)' : ''}\nEarth Io> = ${earthPickup} is available in: ${earthInFirstRow ? 'First Row (0.1-0.475)' : ''} ${earthInSecondRow ? 'Second Row (0.5-1.0)' : ''}\n\nPlease adjust your settings so both protection functions use compatible ranges.`);
            }
            
            // Determine which row to use (prefer first row if both are possible for better accuracy)
            const useSecondRow = canUseBothInSecondRow && !canUseBothInFirstRow;
            
            // STEP 1: Find all CT ranges that can handle the transformer current
            const compatibleCTs = [];
            for (const [ctName, range] of Object.entries(ctRanges)) {
                if (transformerCurrent <= range.max && transformerCurrent >= range.min) {
                    const ctValue = findCTValueInRange(transformerCurrent, range.values);
                    if (ctValue) {
                        compatibleCTs.push({ name: ctName, value: ctValue, range: range });
                    }
                }
            }
            
            if (compatibleCTs.length === 0) {
                throw new Error(`No CT range can handle transformer current ${transformerCurrent}A. Available ranges: CT1(8-28A), CT2(16-56A), CT3(32-112A), CT4(64-224A), CT5(128-448A).`);
            }
            
            // STEP 2: Determine if this is an overlap zone (multiple CT options)
            const isOverlapZone = compatibleCTs.length > 1;
            
            // STEP 3: Apply overlap zone logic for CT selection
            let selectedCT;
            
            if (!isOverlapZone) {
                // Only one CT option available - no choice to make
                selectedCT = compatibleCTs[0];
            } else {
                // Multiple CT options (overlap zone) - choose based on row access needed
                if (useSecondRow) {
                    // Second row access: choose the highest numbered CT from compatible options
                    selectedCT = compatibleCTs[compatibleCTs.length - 1];
                } else {
                    // First row access: choose the lowest numbered CT from compatible options  
                    selectedCT = compatibleCTs[0];
                }
            }
            
            return { 
                ctRange: selectedCT.name, 
                ctValue: selectedCT.value, 
                usesSecondRow: useSecondRow,
                isOverlapZone: isOverlapZone,
                compatibleCTCount: compatibleCTs.length,
                configurationReason: isOverlapZone ? 
                    `Current ${transformerCurrent}A in overlap zone - selected ${selectedCT.name} for ${useSecondRow ? 'extended' : 'standard'} row access (available CTs: ${compatibleCTs.map(ct => ct.name).join(', ')})` :
                    `Current ${transformerCurrent}A requires ${selectedCT.name} (only compatible CT range)`
            };
        }
        
        // Helper function to find the appropriate CT value within a range
        // Protection principle: always round UP to ensure adequate current capacity
        function findCTValueInRange(current, availableValues) {
            for (const value of availableValues) {
                if (value >= current) {
                    return value;
                }
            }
            return null; // Current exceeds this range's capacity
        }
        
        // STEP 5: Convert engineering values to DIP switch positions
        // These functions map protection settings to the physical switch positions
        
        function findSettingPosition(value, settingsArray) {
            const index = settingsArray.indexOf(value);
            return index >= 0 ? index : findClosestPosition(value, settingsArray);
        }
        
        function findClosestPosition(value, settingsArray) {
            // Find the closest available setting for values that don't exactly match
            // This handles user inputs that fall between discrete relay settings
            let bestIndex = 0;
            let minDifference = Math.abs(value - settingsArray[0]);
            
            for (let i = 1; i < settingsArray.length; i++) {
                if (settingsArray[i] === 'E') continue; // Skip "Extremely high" settings for numeric comparison
                const difference = Math.abs(value - settingsArray[i]);
                if (difference < minDifference) {
                    minDifference = difference;
                    bestIndex = i;
                }
            }
            return bestIndex;
        }
        
        // REVERSE ENGINEERING FUNCTIONS
        function reverseBinaryPattern(pattern) {
            // Convert 4-bit pattern back to position index
            for (let i = 0; i < binaryPatterns.length; i++) {
                if (arraysEqual(pattern, binaryPatterns[i])) {
                    return i;
                }
            }
            return 0; // Default to first position if no match
        }
        
        function reverse3BitPattern(pattern) {
            // Convert 3-bit pattern back to position index (for curves)
            const threeBitPatterns = [
                [0,0,0], [1,0,0], [0,1,0], [1,1,0], [0,0,1], [1,0,1], [0,1,1], [1,1,1]
            ];
            for (let i = 0; i < threeBitPatterns.length; i++) {
                if (arraysEqual(pattern, threeBitPatterns[i])) {
                    return i;
                }
            }
            return 0; // Default to first position if no match
        }
        
        function arraysEqual(a, b) {
            return a.length === b.length && a.every((val, i) => val === b[i]);
        }
        
        function reverseEngineerConfiguration() {
            try {
                // Display decoded results directly in the switch info areas
                displayDecodedResults();
                
            } catch (error) {
                console.error('Reverse engineering error:', error);
                alert('Error decoding DIP switch configuration. Please check switch positions and try again.');
            }
        }
        
        function displayDecodedResults() {
            // Instead of showing results in a separate window, show possibilities in the switch info areas
            
            // S1 - Show all possible CT values with compact 2-column layout for CTs
            const s1Pattern = switches.S1.slice(0, 4);
            const s1Index = reverseBinaryPattern(s1Pattern);
            let s1Possibilities = [];
            for (const [ctName, range] of Object.entries(ctRanges)) {
                if (s1Index < range.values.length && range.values[s1Index] !== undefined) {
                    s1Possibilities.push(`${ctName}: ${range.values[s1Index]}A`);
                }
            }
            const s1Basic = [
                switches.S1[6] ? '60Hz' : '50Hz',
                switches.S1[4] ? 'Ext Earth' : 'Int Earth', 
                `HMI ${switches.S1[5] ? 'On' : 'Off'}`,
                `FS ${switches.S1[7] ? 'On' : 'Off'}`
            ];
            
            document.getElementById('s1-info').innerHTML = `
                <strong>Possible CTs:</strong>
                <div class="compact-grid">
                    ${s1Possibilities.map(ct => `<div class="compact-item">${ct}</div>`).join('')}
                </div>
                <strong class="section-break">Basic Settings:</strong>
                <small>${s1Basic.join(', ')}</small>
            `;
            
            // S2 - Time settings (unambiguous) with 2-column layout
            const s2PhasePattern = switches.S2.slice(0, 4);
            const s2EarthPattern = switches.S2.slice(4, 8);
            const phaseTimeIndex = reverseBinaryPattern(s2PhasePattern);
            const earthTimeIndex = reverseBinaryPattern(s2EarthPattern);
            const phaseTime = timeSettings[phaseTimeIndex] || timeSettings[0];
            const earthTime = timeSettings[earthTimeIndex] || timeSettings[0];
            document.getElementById('s2-info').innerHTML = `
                <strong>Time Settings:</strong>
                <div class="two-column">
                    <div class="column-item">Phase 51: ${phaseTime}s</div>
                    <div class="column-item">Earth 51N: ${earthTime}s</div>
                </div>
            `;
            
            // S3 - Show both possible pickup values with correct curve decoding
            const s3PickupPattern = switches.S3.slice(0, 4);
            const s3CurvePattern = switches.S3.slice(5, 8);
            const phasePickupIndex = reverseBinaryPattern(s3PickupPattern);
            const phaseCurveIndex = reverse3BitPattern(s3CurvePattern);
            const phaseValue1 = phaseCurrentSettings.firstRow[phasePickupIndex];
            const phaseValue2 = phaseCurrentSettings.secondRow[phasePickupIndex];
            const phaseCurve = characteristicSettings[phaseCurveIndex] || 'DMT';
            
            let s3Pickups = [];
            if (phaseValue1 !== undefined && phaseValue1 !== 'E') s3Pickups.push(`Row 1: ${phaseValue1}`);
            if (phaseValue2 !== undefined && phaseValue2 !== 'E') s3Pickups.push(`Row 2: ${phaseValue2}`);
            
            document.getElementById('s3-info').innerHTML = `
                <strong>Phase I> Possible:</strong>
                <div class="two-column">
                    ${s3Pickups.map(pickup => `<div class="column-item">${pickup}</div>`).join('')}
                </div>
                <strong class="section-break">Curve:</strong> ${phaseCurve}
            `;
            
            // S4 - Show both possible pickup values with correct curve decoding  
            const s4PickupPattern = switches.S4.slice(0, 4);
            const s4CurvePattern = switches.S4.slice(5, 8);
            const earthPickupIndex = reverseBinaryPattern(s4PickupPattern);
            const earthCurveIndex = reverse3BitPattern(s4CurvePattern);
            const earthValue1 = earthCurrentSettings.firstRow[earthPickupIndex];
            const earthValue2 = earthCurrentSettings.secondRow[earthPickupIndex];
            const earthCurve = characteristicSettings[earthCurveIndex] || 'DMT';
            
            let s4Pickups = [];
            if (earthValue1 !== undefined && earthValue1 !== 'E') s4Pickups.push(`Row 1: ${earthValue1}`);
            if (earthValue2 !== undefined && earthValue2 !== 'E') s4Pickups.push(`Row 2: ${earthValue2}`);
            
            document.getElementById('s4-info').innerHTML = `
                <strong>Earth Io> Possible:</strong>
                <div class="two-column">
                    ${s4Pickups.map(pickup => `<div class="column-item">${pickup}</div>`).join('')}
                </div>
                <strong class="section-break">Curve:</strong> ${earthCurve}
            `;
            
            // S5 - High-set phase (unambiguous) with 2-column layout
            const s5PickupPattern = switches.S5.slice(0, 4);
            const s5TimePattern = switches.S5.slice(4, 8);
            const highsetPhaseIndex = reverseBinaryPattern(s5PickupPattern);
            const highsetPhaseTimeIndex = reverseBinaryPattern(s5TimePattern);
            const phasePickup50 = highsetCurrentSettings[highsetPhaseIndex] || highsetCurrentSettings[0];
            const phaseTime50 = highsetTimeSettings[highsetPhaseTimeIndex] || highsetTimeSettings[0];
            document.getElementById('s5-info').innerHTML = `
                <strong>Phase I>>:</strong>
                <div class="two-column">
                    <div class="column-item">Pickup: ${phasePickup50} √ó In</div>
                    <div class="column-item">Time: ${phaseTime50}s</div>
                </div>
            `;
            
            // S6 - High-set earth (unambiguous) with 2-column layout
            const s6PickupPattern = switches.S6.slice(0, 4);
            const s6TimePattern = switches.S6.slice(4, 8);
            const highsetEarthIndex = reverseBinaryPattern(s6PickupPattern);
            const highsetEarthTimeIndex = reverseBinaryPattern(s6TimePattern);
            const earthPickup50 = highsetCurrentSettings[highsetEarthIndex] || highsetCurrentSettings[0];
            const earthTime50 = highsetTimeSettings[highsetEarthTimeIndex] || highsetTimeSettings[0];
            document.getElementById('s6-info').innerHTML = `
                <strong>Earth Io>>:</strong>
                <div class="two-column">
                    <div class="column-item">Pickup: ${earthPickup50} √ó Is</div>
                    <div class="column-item">Time: ${earthTime50}s</div>
                </div>
            `;
        }
        
        // STEP 6: Create the visual DIP switch elements
        // This preserves your carefully crafted visual design while showing the calculated positions
        
        function createDipSwitch(blockId, number, isOn, label = '', showPositionLabels = false) {
            const switchDiv = document.createElement('div');
            switchDiv.className = 'dip-switch';
            switchDiv.style.marginBottom = number === 7 ? '8px' : '0px';
            
            if (label) {
                const labelText = document.createElement('div');
                labelText.className = 'switch-label-text';
                labelText.textContent = label;
                switchDiv.appendChild(labelText);
            } else {
                const spacer = document.createElement('div');
                spacer.className = 'switch-label-text';
                spacer.textContent = '';
                switchDiv.appendChild(spacer);
            }
            
            const switchNumber = document.createElement('div');
            switchNumber.className = 'switch-number';
            switchNumber.textContent = number;
            switchDiv.appendChild(switchNumber);
            
            const switchContainer = document.createElement('div');
            switchContainer.className = 'switch-container';
            
            const sliderContainer = document.createElement('div');
            sliderContainer.className = `switch-slider ${isOn ? 'switch-on' : 'switch-off'}`;
            sliderContainer.style.width = '50px';
            
            // Add click handler for reverse engineering mode
            if (currentMode === 'reverse') {
                sliderContainer.style.cursor = 'pointer';
                sliderContainer.onclick = function() {
                    toggleSwitch(blockId, number - 1);
                };
            }
            
            const toggle = document.createElement('div');
            toggle.className = 'switch-toggle';
            toggle.style.left = isOn ? '24px' : '1px';
            toggle.style.width = '24px';
            
            sliderContainer.appendChild(toggle);
            switchContainer.appendChild(sliderContainer);
            
            if (showPositionLabels) {
                const labels = document.createElement('div');
                labels.className = 'position-labels';
                labels.innerHTML = '<span>OFF</span><span>ON</span>';
                labels.style.width = '50px';
                labels.style.marginTop = '4px';
                switchContainer.appendChild(labels);
            }
            
            switchDiv.appendChild(switchContainer);
            return switchDiv;
        }
        
        function toggleSwitch(blockId, switchIndex) {
            switches[blockId][switchIndex] = switches[blockId][switchIndex] === 1 ? 0 : 1;
            displayEmptySwitches(); // Refresh display
        }
        
        function displayEmptySwitches() {
            const switchLabels = {
                S1: ['Is', '', '', '', 'Io>', 'Fn', 'HMI', 'Fs'],
                S2: ['t>/k', '', '', '', 'to>/ko', '', '', ''],
                S3: ['I>', '', '', '', '', 'CI', '', ''],
                S4: ['Io>', '', '', '', '', 'CE', '', ''],
                S5: ['I>>', '', '', '', 't>>', '', '', ''],
                S6: ['Io>>', '', '', '', 'to>>', '', '', '']
            };
            
            for (let block in switches) {
                const blockDiv = document.getElementById(`switch${block}`);
                blockDiv.innerHTML = '';
                
                for (let i = 0; i < 8; i++) {
                    const label = switchLabels[block][i];
                    const showPositionLabels = (i === 7);
                    const dipSwitch = createDipSwitch(block, i + 1, switches[block][i] === 1, label, showPositionLabels);
                    blockDiv.appendChild(dipSwitch);
                }
            }
            
            // Update info boxes for reverse mode with standardized formatting
            if (currentMode === 'reverse') {
                document.getElementById('s1-info').innerHTML = `
                    <strong>CT Range + Basic:</strong>
                    Click switches above
                    <small>Sets CT, frequency, earth fault, HMI, failsafe</small>
                `;
                document.getElementById('s2-info').innerHTML = `
                    <strong>Time Settings:</strong>
                    Click switches above
                    <small>Phase & earth fault times</small>
                `;
                document.getElementById('s3-info').innerHTML = `
                    <strong>Phase I> + Curve:</strong>
                    Click switches above
                    <small>Pickup current & characteristic curve</small>
                `;
                document.getElementById('s4-info').innerHTML = `
                    <strong>Earth Io> + Curve:</strong>
                    Click switches above
                    <small>Pickup current & characteristic curve</small>
                `;
                document.getElementById('s5-info').innerHTML = `
                    <strong>Phase High-set:</strong>
                    Click switches above
                    <small>I>> pickup current & time</small>
                `;
                document.getElementById('s6-info').innerHTML = `
                    <strong>Earth High-set:</strong>
                    Click switches above
                    <small>Io>> pickup current & time</small>
                `;
            }
        }
        
        // STEP 7: MAIN CALCULATION FUNCTION
        // This is where all the protection engineering logic comes together
        
        function calculateDipSwitches() {
            try {
                // Hide any previous error display when starting new calculation
                document.getElementById('errorDisplay').style.display = 'none';
                // Gather all user inputs
                const transformerCurrent = parseFloat(document.getElementById('transformerCurrent').value);
                const earthFault = document.querySelector('input[name="earthFault"]:checked').value;
                const frequency = document.querySelector('input[name="frequency"]:checked').value;
                const hmi = document.querySelector('input[name="hmi"]:checked').value;
                const failsafe = document.querySelector('input[name="failsafe"]:checked').value;
                
                const phasePickup51 = parseFloat(document.getElementById('phasePickup51').value);
                const phaseCurve51 = document.getElementById('phaseCurve51').value;
                const phaseTime51 = parseFloat(document.getElementById('phaseTime51').value);
                const phasePickup50 = parseFloat(document.getElementById('phasePickup50').value);
                const phaseTime50 = parseFloat(document.getElementById('phaseTime50').value);
                
                const earthPickup51N = parseFloat(document.getElementById('earthPickup51N').value);
                const earthCurve51N = document.getElementById('earthCurve51N').value;
                const earthTime51N = parseFloat(document.getElementById('earthTime51N').value);
                const earthPickup50N = parseFloat(document.getElementById('earthPickup50N').value);
                const earthTime50N = parseFloat(document.getElementById('earthTime50N').value);
                
                if (!transformerCurrent) {
                    alert('Please enter the transformer rated current.');
                    return;
                }
                
                // APPLY THE CONSTRAINT-BASED SELECTION ALGORITHM
                const ctConfig = determineRequiredCTConfiguration(transformerCurrent, phasePickup51, earthPickup51N);
                
                // Initialize all DIP switches to OFF position
                switches = {
                    S1: [0,0,0,0,0,0,0,0],
                    S2: [0,0,0,0,0,0,0,0],
                    S3: [0,0,0,0,0,0,0,0],
                    S4: [0,0,0,0,0,0,0,0],
                    S5: [0,0,0,0,0,0,0,0],
                    S6: [0,0,0,0,0,0,0,0]
                };
                
                // Configure S1: CT selection and basic settings
                const ctPosition = findSettingPosition(ctConfig.ctValue, ctRanges[ctConfig.ctRange].values);
                const ctPattern = binaryPatterns[ctPosition];
                for (let i = 0; i < 4; i++) {
                    switches.S1[i] = ctPattern[i];
                }
                
                switches.S1[4] = earthFault === 'external' ? 1 : 0;  // Earth fault measurement
                switches.S1[5] = hmi === 'enabled' ? 1 : 0;          // S1-6: HMI
                switches.S1[6] = frequency === '60Hz' ? 1 : 0;       // S1-7: Frequency (Fn)
                switches.S1[7] = failsafe === 'enabled' ? 1 : 0;     // Failsafe
                
                // Configure S2: Time settings
                const phaseTimePos = findSettingPosition(phaseTime51, timeSettings);
                const earthTimePos = findSettingPosition(earthTime51N, timeSettings);
                
                const phaseTimePattern = binaryPatterns[phaseTimePos];
                const earthTimePattern = binaryPatterns[earthTimePos];
                
                for (let i = 0; i < 4; i++) {
                    switches.S2[i] = phaseTimePattern[i];
                    switches.S2[i + 4] = earthTimePattern[i];
                }
                
                // Configure S3: Phase protection settings
                const phaseSettingsRow = ctConfig.usesSecondRow ? phaseCurrentSettings.secondRow : phaseCurrentSettings.firstRow;
                const phasePickupPos = findSettingPosition(phasePickup51, phaseSettingsRow);
                const phasePickupPattern = binaryPatterns[phasePickupPos];
                
                for (let i = 0; i < 5; i++) {
                    switches.S3[i] = phasePickupPattern[i];
                }
                
                const phaseCurvePos = characteristicSettings.indexOf(phaseCurve51);
                if (phaseCurvePos >= 0) {
                    const phaseCurvePattern = binaryPatterns[phaseCurvePos];
                    for (let i = 0; i < 3; i++) {
                        switches.S3[i + 5] = phaseCurvePattern[i];
                    }
                }
                
                // Configure S4: Earth fault protection settings  
                const earthSettingsRow = ctConfig.usesSecondRow ? earthCurrentSettings.secondRow : earthCurrentSettings.firstRow;
                const earthPickupPos = findSettingPosition(earthPickup51N, earthSettingsRow);
                const earthPickupPattern = binaryPatterns[earthPickupPos];
                
                for (let i = 0; i < 5; i++) {
                    switches.S4[i] = earthPickupPattern[i];
                }
                
                const earthCurvePos = characteristicSettings.indexOf(earthCurve51N);
                if (earthCurvePos >= 0) {
                    const earthCurvePattern = binaryPatterns[earthCurvePos];
                    for (let i = 0; i < 3; i++) {
                        switches.S4[i + 5] = earthCurvePattern[i];
                    }
                }
                
                // Configure S5: High-set phase protection
                const highsetPhasePos = findSettingPosition(phasePickup50, highsetCurrentSettings);
                const highsetPhaseTimePos = findSettingPosition(phaseTime50, highsetTimeSettings);
                
                const highsetPhasePattern = binaryPatterns[highsetPhasePos];
                const highsetPhaseTimePattern = binaryPatterns[highsetPhaseTimePos];
                
                for (let i = 0; i < 4; i++) {
                    switches.S5[i] = highsetPhasePattern[i];
                    switches.S5[i + 4] = highsetPhaseTimePattern[i];
                }
                
                // Configure S6: High-set earth fault protection
                const highsetEarthPos = findSettingPosition(earthPickup50N, highsetCurrentSettings);
                const highsetEarthTimePos = findSettingPosition(earthTime50N, highsetTimeSettings);
                
                const highsetEarthPattern = binaryPatterns[highsetEarthPos];
                const highsetEarthTimePattern = binaryPatterns[highsetEarthTimePos];
                
                for (let i = 0; i < 4; i++) {
                    switches.S6[i] = highsetEarthPattern[i];
                    switches.S6[i + 4] = highsetEarthTimePattern[i];
                }
                
                // Display the results with engineering context and diagnostic information
                displayResults(switches, {
                    transformerCurrent: transformerCurrent,
                    ctRange: ctConfig.ctRange,
                    ctValue: ctConfig.ctValue,
                    usesSecondRow: ctConfig.usesSecondRow,
                    isOverlapZone: ctConfig.isOverlapZone,
                    compatibleCTCount: ctConfig.compatibleCTCount,
                    configurationReason: ctConfig.configurationReason,
                    phasePickup51: phasePickup51,
                    earthPickup51N: earthPickup51N,
                    phaseTime51: phaseTime51,
                    earthTime51N: earthTime51N
                });
                
            } catch (error) {
                // Hide results and show error in user-friendly format
                document.getElementById('results').style.display = 'none';
                const errorDisplay = document.getElementById('errorDisplay');
                const errorMessage = document.getElementById('errorMessage');
                
                // Create educational error message that helps engineers understand the constraints
                let errorText = error.message;
                let learningPoint = '';
                
                if (error.message.includes('require different setting rows')) {
                    learningPoint = 'üìö <strong>Learning Point:</strong> The REJ603 relay requires both phase and earth protection functions to use settings from the same row (either first row or second row). This ensures internal consistency and prevents coordination conflicts between protection functions.';
                } else if (error.message.includes('not available in any setting range')) {
                    learningPoint = 'üìö <strong>Learning Point:</strong> Each protection function has specific discrete setting values available. The relay cannot interpolate between these values, so you must choose from the available options in the relay\'s lookup tables.';
                } else if (error.message.includes('exceeds the maximum capacity') || error.message.includes('can handle transformer current')) {
                    learningPoint = 'üìö <strong>Learning Point:</strong> This configuration requires a CT range that can handle both your current requirements and provide access to your required setting ranges. You may need to adjust your protection settings to use compatible ranges.';
                }
                
                errorMessage.innerHTML = `
                    <p style="margin: 10px 0; white-space: pre-line;">${errorText}</p>
                    ${learningPoint ? `<div style="background-color: #e7f3ff; padding: 10px; border-radius: 4px; margin-top: 15px; border-left: 4px solid #0066cc;">${learningPoint}</div>` : ''}
                    <p style="margin: 15px 0 5px 0;"><strong>üí° Suggestion:</strong> Try adjusting your protection settings so both phase and earth functions use compatible setting ranges, or verify that your transformer current falls within the available CT ranges.</p>
                `;
                
                errorDisplay.style.display = 'block';
                console.error('Configuration error:', error);
            }
        }
        
        // STEP 8: Display the results with engineering insights
        // Show not just the switch positions, but explain the engineering decisions made
        
        function displayResults(switches, calculatedValues) {
            const resultsDiv = document.getElementById('results');
            const calculatedDiv = document.getElementById('calculatedValues');
            
            // Create an engineering summary that explains the CT selection logic
            const rowAccessExplanation = calculatedValues.usesSecondRow ? 
                'Uses extended setting ranges (second row access)' : 
                'Uses standard setting ranges (first row access)';
            
            calculatedDiv.innerHTML = `
                <h3>Protection Engineering Analysis:</h3>
                <p><strong>Transformer Current:</strong> ${calculatedValues.transformerCurrent}A ‚Üí <strong>Selected CT:</strong> ${calculatedValues.ctRange} (${calculatedValues.ctValue}A)</p>
                <p><strong>Configuration Strategy:</strong> ${rowAccessExplanation}</p>
                <p><strong>Phase Protection:</strong> I> = ${calculatedValues.phasePickup51} √ó In, t> = ${calculatedValues.phaseTime51}s</p>
                <p><strong>Earth Protection:</strong> Io> = ${calculatedValues.earthPickup51N} √ó Is, to> = ${calculatedValues.earthTime51N}s</p>
            `;
            
            // Update the switch information displays to show BOTH values each switch configures
            const earthFault = document.querySelector('input[name="earthFault"]:checked').value;
            const frequency = document.querySelector('input[name="frequency"]:checked').value;
            const hmi = document.querySelector('input[name="hmi"]:checked').value;
            const failsafe = document.querySelector('input[name="failsafe"]:checked').value;
            const phaseCurve51 = document.getElementById('phaseCurve51').value;
            const earthCurve51N = document.getElementById('earthCurve51N').value;
            const phasePickup50 = parseFloat(document.getElementById('phasePickup50').value);
            const phaseTime50 = parseFloat(document.getElementById('phaseTime50').value);
            const earthPickup50N = parseFloat(document.getElementById('earthPickup50N').value);
            const earthTime50N = parseFloat(document.getElementById('earthTime50N').value);
            
            document.getElementById('s1-info').innerHTML = `
                <strong>${calculatedValues.ctRange}</strong>
                ${calculatedValues.ctValue}A CT
                <strong class="section-break">Basic Settings:</strong>
                <small>${frequency}, ${earthFault === 'external' ? 'Ext' : 'Int'} Earth, HMI ${hmi === 'enabled' ? 'On' : 'Off'}, FS ${failsafe === 'enabled' ? 'On' : 'Off'}</small>
            `;
            document.getElementById('s2-info').innerHTML = `
                <strong>Time Settings:</strong>
                <div class="two-column">
                    <div class="column-item">Phase: ${calculatedValues.phaseTime51}s</div>
                    <div class="column-item">Earth: ${calculatedValues.earthTime51N}s</div>
                </div>
            `;
            document.getElementById('s3-info').innerHTML = `
                <strong>Phase Protection:</strong>
                I> = ${calculatedValues.phasePickup51} √ó In
                <strong class="section-break">Curve:</strong> ${phaseCurve51}
            `;
            document.getElementById('s4-info').innerHTML = `
                <strong>Earth Protection:</strong>
                Io> = ${calculatedValues.earthPickup51N} √ó Is
                <strong class="section-break">Curve:</strong> ${earthCurve51N}
            `;
            document.getElementById('s5-info').innerHTML = `
                <strong>Phase High-set:</strong>
                <div class="two-column">
                    <div class="column-item">I>> = ${phasePickup50} √ó In</div>
                    <div class="column-item">Time: ${phaseTime50}s</div>
                </div>
            `;
            document.getElementById('s6-info').innerHTML = `
                <strong>Earth High-set:</strong>
                <div class="two-column">
                    <div class="column-item">Io>> = ${earthPickup50N} √ó Is</div>
                    <div class="column-item">Time: ${earthTime50N}s</div>
                </div>
            `;
            
            // Generate the visual DIP switch displays
            const switchLabels = {
                S1: ['Is', '', '', '', 'Io>', 'Fn', 'HMI', 'Fs'],
                S2: ['t>/k', '', '', '', 'to>/ko', '', '', ''],
                S3: ['I>', '', '', '', '', 'CI', '', ''],
                S4: ['Io>', '', '', '', '', 'CE', '', ''],
                S5: ['I>>', '', '', '', 't>>', '', '', ''],
                S6: ['Io>>', '', '', '', 'to>>', '', '', '']
            };
            
            for (let block in switches) {
                const blockDiv = document.getElementById(`switch${block}`);
                blockDiv.innerHTML = '';
                
                for (let i = 0; i < 8; i++) {
                    const label = switchLabels[block][i];
                    const showPositionLabels = (i === 7);
                    const dipSwitch = createDipSwitch(block, i + 1, switches[block][i] === 1, label, showPositionLabels);
                    blockDiv.appendChild(dipSwitch);
                }
            }
            
            resultsDiv.style.display = 'block';
        }
    </script>
</body>
</html>