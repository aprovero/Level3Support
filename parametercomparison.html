<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1CoE Level 3 - Parameter Comparison Tool</title>
    <link rel="icon" type="image/x-icon" href="images/SIMPLE_LOGO.png">
    <!-- Your shared styles -->
    <link rel="stylesheet" href="css/shared-styles.css">
    
    <!-- Required React libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
    
</head>
<body>
    <div class="container">
        <!-- Header - Unchanged from your site -->
        <div class="header">
            <div class="logo">
                <img src="images/LOGO.png" alt="Logo">
            </div>
            <div class="header-icons">
                <div class="training-icon">
                    <a href="training.html">
                        <img src="images/training-icon.png" alt="Training Materials">
                    </a>
                </div>
                <div class="contact-icon">
                    <a href="contacts.html">
                        <img src="images/contact-icon.png" alt="Contact Directory">
                    </a>
                </div>
            </div>
        </div>
        <a href="index.html" class="back-link">← Back to the Request Form</a>
        
        <h1>Parameter Comparison Tool</h1>
        
        <!-- React app container -->
        <div id="parameter-comparison-app"></div>
        
        <!-- Footer - Unchanged from your site -->
        <footer class="footer">
            <div class="footer-text">
                <div class="footer-copyright">© 2025 CoE LATAM, Sungrow Americas. All Rights Reserved.</div>
                <div class="footer-creator">Created by Andres Provero</div>
            </div>
            <div class="footer-logo">
                <a href="https://www.anthropic.com" target="_blank">
                    <img src="images/CLAUDE_LOGO.png" alt="Claude Logo">
                </a>
                <img src="images/COE_LOGO.png" alt="CoE LATAM Logo">
            </div>
        </footer>
    </div>

    <!-- React Component Script -->
    <script type="text/babel">
        // Parameter Comparison Tool React Component
        const { useState, useEffect } = React;
        
        const ParameterComparisonTool = () => {
            const [files, setFiles] = useState({});
            const [allParameters, setAllParameters] = useState([]);
            const [comparisonData, setComparisonData] = useState([]);
            const [showOnlyDifferences, setShowOnlyDifferences] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [message, setMessage] = useState({ type: '', text: '' });
            
            // Update all parameters when files change
            useEffect(() => {
                if (Object.keys(files).length > 0) {
                    updateAllParameters();
                }
            }, [files]);
            
            // Generate comparison data when parameters or files change
            useEffect(() => {
                if (Object.keys(files).length >= 2 && allParameters.length > 0) {
                    generateComparisonData();
                }
            }, [allParameters, files]);
            
            // Handle file upload
            const handleFileUpload = async (event) => {
                const uploadedFiles = event.target.files;
                if (!uploadedFiles || !uploadedFiles.length) return;
                
                // Check for duplicate file names
                const existingFileNames = Object.keys(files);
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    if (existingFileNames.includes(file.name)) {
                        setMessage({ 
                            type: 'error', 
                            text: `Error: File "${file.name}" is already uploaded. Files must have different names.` 
                        });
                        return;
                    }
                }
                
                // Limit to 3 files
                if (existingFileNames.length + uploadedFiles.length > 3) {
                    setMessage({ 
                        type: 'warning', 
                        text: 'Maximum 3 files recommended. Please remove some files first.' 
                    });
                    return;
                }
                
                setMessage({ type: 'info', text: 'Reading files, please wait...' });
                
                // Process each file
                const newFiles = { ...files };
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    try {
                        const content = await readFileAsText(file);
                        const parsedData = parseCSV(content);
                        
                        if (!isValidParameterFile(parsedData)) {
                            setMessage({ 
                                type: 'error', 
                                text: `Error: "${file.name}" does not appear to be a valid parameter file. It should have columns for Parameter Name, Current Value, and Illustrate.` 
                            });
                            return;
                        }
                        
                        // Create parameter map
                        const paramMap = {};
                        parsedData.data.forEach(row => {
                            if (!row['Parameter Name'] || row['Current Value'] === undefined) return;
                            
                            paramMap[row['Parameter Name']] = {
                                value: normalizeValue(row['Current Value']),
                                illustrate: row['Illustrate'] || ''
                            };
                        });
                        
                        // Store the file data
                        newFiles[file.name] = {
                            paramMap,
                            displayName: file.name.replace('.csv', '')
                        };
                    } catch (err) {
                        setMessage({ 
                            type: 'error', 
                            text: `Error reading ${file.name}: ${err.message}` 
                        });
                        return;
                    }
                }
                
                setFiles(newFiles);
                setMessage({ type: '', text: '' });
                
                // Clear file input for re-uploads
                event.target.value = '';
            };
            
            // Normalize numeric values to have 2 decimal places
            const normalizeValue = (value) => {
                if (value === undefined || value === null || value === '') return '';
                
                // Check if it's a numeric string (could have decimals or not)
                if (/^-?\d+(\.\d+)?$/.test(value.toString().trim())) {
                    const num = parseFloat(value);
                    // Only add decimals if the original value had them
                    if (value.toString().includes('.')) {
                        return num.toFixed(2);
                    }
                    return num.toString();
                }
                
                // Return original value if not a number
                return value.toString().trim();
            };
            
            // Check if the parsed data appears to be a valid parameter file
            const isValidParameterFile = (parsedData) => {
                if (!parsedData.data || !parsedData.data.length) return false;
                
                // Check if the required columns exist
                const fields = Object.keys(parsedData.data[0] || {});
                return fields.includes('Parameter Name') && fields.includes('Current Value');
            };
            
            // Helper function to read file as text
            const readFileAsText = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error("File reading failed"));
                    reader.readAsText(file);
                });
            };
            
            // Parse CSV data
            const parseCSV = (csvText) => {
                // Simple CSV parser
                const lines = csvText.split(/\r\n|\n/);
                const headers = lines[0].split(',').map(h => h.trim());
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = line.split(',');
                    const row = {};
                    
                    for (let j = 0; j < headers.length; j++) {
                        row[headers[j]] = values[j] ? values[j].trim() : '';
                    }
                    
                    data.push(row);
                }
                
                return { data, headers };
            };
            
            // Update the master list of all parameters
            const updateAllParameters = () => {
                const paramSet = new Set();
                
                Object.values(files).forEach(file => {
                    Object.keys(file.paramMap).forEach(param => {
                        paramSet.add(param);
                    });
                });
                
                setAllParameters([...paramSet].sort());
            };
            
            // Generate data for comparison table
            const generateComparisonData = () => {
                if (Object.keys(files).length < 2 || !allParameters.length) {
                    setComparisonData([]);
                    return;
                }
                
                const fileNames = Object.keys(files);
                
                const data = allParameters.map(param => {
                    const paramData = {
                        parameterName: param,
                        hasDifferences: false,
                        values: {}
                    };
                    
                    // Store parameter values from each file
                    fileNames.forEach(fileName => {
                        const file = files[fileName];
                        paramData.values[file.displayName] = file.paramMap[param] || { value: 'N/A', illustrate: '' };
                    });
                    
                    // Check if there are differences in parameter values
                    const uniqueValues = new Set();
                    Object.values(paramData.values).forEach(v => uniqueValues.add(v.value));
                    paramData.hasDifferences = uniqueValues.size > 1;
                    
                    return paramData;
                });
                
                setComparisonData(data);
            };
            
            // Remove a file
            const removeFile = (fileName) => {
                const newFiles = { ...files };
                delete newFiles[fileName];
                setFiles(newFiles);
            };
            
            // Reset everything
            const resetAll = () => {
                setFiles({});
                setAllParameters([]);
                setComparisonData([]);
                setMessage({ type: '', text: '' });
                setShowOnlyDifferences(false);
                setSearchTerm('');
            };
            
            // Filter data based on search and show only differences
            const getFilteredData = () => {
                if (!comparisonData.length) return [];
                
                let filtered = [...comparisonData];
                
                // Filter for differences
                if (showOnlyDifferences) {
                    filtered = filtered.filter(item => item.hasDifferences);
                }
                
                // Filter by search term
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(item => 
                        item.parameterName.toLowerCase().includes(term)
                    );
                }
                
                return filtered;
            };
            
            // Get statistics
            const getStats = () => {
                const totalParams = allParameters.length;
                const diffParams = comparisonData.filter(p => p.hasDifferences).length;
                const missingParams = comparisonData.filter(p => 
                    Object.values(p.values).some(v => v.value === 'N/A')
                ).length;
                
                return { totalParams, diffParams, missingParams };
            };
            
            // Render file upload section
            const renderFileUpload = () => {
                return (
                    <div className="card">
                        <h2 className="card-title">Upload CSV Files (2-3 recommended)</h2>
                        <div>
                            <label className="file-upload-button" htmlFor="file-input">
                                Choose CSV Files
                            </label>
                            <input 
                                id="file-input"
                                type="file" 
                                accept=".csv" 
                                multiple 
                                onChange={handleFileUpload} 
                                className="file-input"
                            />
                            <span className="file-info">Files must have different names.</span>
                            
                            {message.text && (
                                <div className={`message ${message.type}`}>
                                    {message.text}
                                </div>
                            )}
                            
                            {Object.keys(files).length > 0 && (
                                <div className="file-list">
                                    <p>Uploaded Files ({Object.keys(files).length}):</p>
                                    {Object.keys(files).map(fileName => (
                                        <div key={fileName} className="file-item">
                                            <span className="file-name">{fileName}</span>
                                            <button 
                                                className="remove-button" 
                                                onClick={() => removeFile(fileName)}
                                            >
                                                ×
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };
            
            // Render comparison section
            const renderComparison = () => {
                if (Object.keys(files).length < 2) {
                    return (
                        <div className="instructions">
                            <h3>How to Use This Tool</h3>
                            <ol>
                                <li>Upload 2 or 3 CSV files containing system parameters with the columns:
                                    <ul>
                                        <li>Parameter Name</li>
                                        <li>Current Value</li>
                                        <li>Illustrate (allowed values/ranges)</li>
                                    </ul>
                                </li>
                                <li>The tool will automatically compare all parameters across files</li>
                                <li>Use the checkbox to show only parameters that differ between files</li>
                                <li>Use the search box to find specific parameters</li>
                                <li>Parameters with differences will be highlighted in yellow and red</li>
                            </ol>
                        </div>
                    );
                }
                
                const { totalParams, diffParams, missingParams } = getStats();
                const filteredData = getFilteredData();
                const fileDisplayNames = Object.values(files).map(f => f.displayName);
                
                return (
                    <>
                        <div className="card">
                            <h2 className="card-title">Comparison Settings</h2>
                            <div className="controls">
                                <div className="checkbox-control">
                                    <input 
                                        type="checkbox" 
                                        id="show-differences" 
                                        checked={showOnlyDifferences}
                                        onChange={() => setShowOnlyDifferences(!showOnlyDifferences)}
                                    />
                                    <label htmlFor="show-differences">Show only different parameters</label>
                                </div>
                                
                                <div className="search-control">
                                    <span className="search-icon">
                                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                        </svg>
                                    </span>
                                    <input 
                                        type="text" 
                                        className="search-input" 
                                        placeholder="Search parameters..." 
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>
                                
                                <button className="reset-button" onClick={resetAll}>
                                    Reset All
                                </button>
                            </div>
                            
                            <div className="stats-grid">
                                <div className="stat-card">
                                    <div className="stat-label">Total Parameters</div>
                                    <div className="stat-value total">{totalParams}</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-label">Different Parameters</div>
                                    <div className="stat-value different">{diffParams}</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-label">Missing Parameters</div>
                                    <div className="stat-value missing">{missingParams}</div>
                                </div>
                            </div>
                        </div>
                        
                        {filteredData.length > 0 ? (
                            <div className="table-container">
                                <div className="scrollable">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Parameter Name</th>
                                                {fileDisplayNames.map(name => (
                                                    <th key={name}>{name}</th>
                                                ))}
                                                <th>Allowed Values</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {filteredData.map(param => (
                                                <tr 
                                                    key={param.parameterName}
                                                    className={param.hasDifferences ? 'highlight-row' : ''}
                                                >
                                                    <td className="parameter-name">{param.parameterName}</td>
                                                    
                                                    {fileDisplayNames.map(displayName => {
                                                        const paramValue = param.values[displayName]?.value || 'N/A';
                                                        const isDifferent = param.hasDifferences && 
                                                            Object.entries(param.values)
                                                                .filter(([name]) => name !== displayName)
                                                                .some(([_, v]) => v.value !== paramValue && v.value !== 'N/A');
                                                        
                                                        return (
                                                            <td 
                                                                key={`${param.parameterName}-${displayName}`}
                                                                className={isDifferent ? 'different-value' : ''}
                                                            >
                                                                {paramValue}
                                                            </td>
                                                        );
                                                    })}
                                                    
                                                    <td className="allowed-values">
                                                        {(() => {
                                                            // Get illustrate value from the first file that has it
                                                            for (const displayName of fileDisplayNames) {
                                                                const illustrateValue = param.values[displayName]?.illustrate;
                                                                if (illustrateValue) {
                                                                    return illustrateValue;
                                                                }
                                                            }
                                                            return '';
                                                        })()}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ) : (
                            <div className="no-results">
                                <p>No parameters found matching your criteria.</p>
                            </div>
                        )}
                    </>
                );
            };
            
            return (
                <div className="app-container">
                    {renderFileUpload()}
                    {renderComparison()}
                </div>
            );
        };
        
        // Render the app
        ReactDOM.render(
            <ParameterComparisonTool />,
            document.getElementById('parameter-comparison-app')
        );
    </script>
</body>
</html>