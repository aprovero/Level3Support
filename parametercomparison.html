<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoE Level 3 - Parameter Comparison Tool</title>
    <link rel="icon" type="image/x-icon" href="images/SIMPLE_LOGO.png">
    <!-- Your shared styles - corrected path -->
    <link rel="stylesheet" href="css/shared-styles.css">
    <style>
        /* Additional styles to match React version */
        body {
            font-family: Arial, sans-serif;
            color: #333;
            background-color: #f9f9f9;
        }
        
        .tool-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .file-input-section {
            margin-bottom: 20px;
        }
        
        .file-input-wrapper {
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .file-input-button {
            background-color: #0066cc;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            border: none;
        }
        
        .file-input-button:hover {
            background-color: #0056b3;
        }
        
        .uploaded-files {
            margin-top: 15px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .file-name {
            font-weight: 500;
        }
        
        .file-remove {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        
        .controls-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            margin-right: 8px;
            width: auto;
        }
        
        .search-wrapper {
            position: relative;
            flex-grow: 1;
            max-width: 300px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px 8px 32px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .reset-button {
            background-color: #f0f0f0;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }
        
        .reset-button:hover {
            background-color: #e0e0e0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .diff-value {
            color: #ffc107;
        }
        
        .missing-value {
            color: #dc3545;
        }
        
        .table-wrapper {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .comparison-table th {
            background-color: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .comparison-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .comparison-table tr:last-child td {
            border-bottom: none;
        }
        
        .comparison-table tr.different-row {
            background-color: #fff3cd;
        }
        
        .comparison-table td.different-value {
            color: #dc3545;
            font-weight: 600;
        }
        
        .parameter-name-cell {
            font-weight: 500;
        }
        
        .allowed-values-cell {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .scrollable-table {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            background-color: #f8f9fa;
            border-radius: 6px;
            color: #6c757d;
        }
        
        .instructions {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 20px;
        }
        
        .instructions h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .instructions ol {
            margin-left: 20px;
            margin-bottom: 0;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .instructions ul {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Fix the checkbox appearing too large */
        input[type="checkbox"] {
            width: auto !important;
            margin-bottom: 0 !important;
        }
        
        /* Fix the search input alignment */
        input.search-input {
            margin-bottom: 0 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header - Unchanged from your site -->
        <div class="header">
            <div class="logo">
                <img src="images/LOGO.png" alt="Logo">
            </div>
            <div class="header-icons">
                <div class="training-icon">
                    <a href="training.html">
                        <img src="images/training-icon.png" alt="Training Materials">
                    </a>
                </div>
                <div class="contact-icon">
                    <a href="contacts.html">
                        <img src="images/contact-icon.png" alt="Contact Directory">
                    </a>
                </div>
            </div>
        </div>
        <a href="index.html" class="back-link">← Back to the Request Form</a>
        
        <!-- Main Content - Styled like React version -->
        <h1>Parameter Comparison Tool</h1>
        
        <div class="tool-container">
            <h2>Upload CSV Files (2-3 recommended)</h2>
            <div class="file-input-section">
                <div class="file-input-wrapper">
                    <button class="file-input-button">Choose CSV Files</button>
                    <input type="file" id="file-input" accept=".csv" multiple style="display: none;">
                </div>
                <p class="small-text">Files must have different names. Files should contain Parameter Name, Current Value, and Illustrate columns.</p>
                <div id="upload-status" class="mt-2"></div>
                
                <div id="uploaded-files" class="uploaded-files"></div>
            </div>
        </div>
        
        <div id="comparison-container" class="tool-container hidden">
            <h2>Comparison Settings</h2>
            <div class="controls-section">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="show-differences">
                    <label for="show-differences">Show only different parameters</label>
                </div>
                
                <div class="search-wrapper">
                    <span class="search-icon">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                    </span>
                    <input type="text" id="search-parameter" class="search-input" placeholder="Search parameters...">
                </div>
                
                <button id="reset-btn" class="reset-button">Reset All</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Parameters</div>
                    <div id="total-params" class="stat-value">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Different Parameters</div>
                    <div id="diff-params" class="stat-value diff-value">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Missing Parameters</div>
                    <div id="missing-params" class="stat-value missing-value">-</div>
                </div>
            </div>
            
            <div id="table-wrapper" class="table-wrapper">
                <div class="scrollable-table">
                    <table id="comparison-table" class="comparison-table">
                        <thead>
                            <tr>
                                <th>Parameter Name</th>
                                <!-- File columns will be added dynamically -->
                                <th>Allowed Values</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-tbody">
                            <!-- Table content will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="no-results" class="no-results hidden">
                <p>No parameters found matching your criteria.</p>
            </div>
        </div>
        
        <div id="instructions" class="instructions">
            <h3>How to Use This Tool</h3>
            <ol>
                <li>Upload 2 or 3 CSV files containing system parameters with the columns:
                    <ul>
                        <li>Parameter Name</li>
                        <li>Current Value</li>
                        <li>Illustrate (allowed values/ranges)</li>
                    </ul>
                </li>
                <li>The tool will automatically compare all parameters across files</li>
                <li>Use the checkbox to show only parameters that differ between files</li>
                <li>Use the search box to find specific parameters</li>
                <li>Parameters with differences will be highlighted in red and rows will have a yellow background</li>
            </ol>
        </div>
        
        <!-- Footer - Unchanged from your site -->
        <footer class="footer">
            <div class="footer-text">
                <div class="footer-copyright">© 2025 CoE LATAM, Sungrow Americas. All Rights Reserved.</div>
                <div class="footer-creator">Created by Andres Provero</div>
            </div>
            <div class="footer-logo">
                <a href="https://www.anthropic.com" target="_blank">
                    <img src="images/CLAUDE_LOGO.png" alt="Claude Logo">
                </a>
                <img src="images/COE_LOGO.png" alt="CoE LATAM Logo">
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const fileInput = document.getElementById('file-input');
            const fileInputButton = document.querySelector('.file-input-button');
            const uploadedFiles = document.getElementById('uploaded-files');
            const uploadStatus = document.getElementById('upload-status');
            const comparisonContainer = document.getElementById('comparison-container');
            const comparisonTable = document.getElementById('comparison-table');
            const comparisonTbody = document.getElementById('comparison-tbody');
            const showDifferences = document.getElementById('show-differences');
            const searchParameter = document.getElementById('search-parameter');
            const resetBtn = document.getElementById('reset-btn');
            const instructions = document.getElementById('instructions');
            const noResults = document.getElementById('no-results');
            const totalParamsEl = document.getElementById('total-params');
            const diffParamsEl = document.getElementById('diff-params');
            const missingParamsEl = document.getElementById('missing-params');
            
            // Connect the button to the file input
            fileInputButton.addEventListener('click', function() {
                fileInput.click();
            });
            
            // Global data storage
            let files = {};
            let allParameters = [];
            let comparisonData = [];
            
            // Listen for file uploads
            fileInput.addEventListener('change', handleFileUpload);
            
            // Listen for filter changes
            showDifferences.addEventListener('change', filterResults);
            searchParameter.addEventListener('input', filterResults);
            
            // Reset button
            resetBtn.addEventListener('click', resetAll);
            
            async function handleFileUpload(event) {
                const uploadedFiles = event.target.files;
                if (!uploadedFiles.length) return;
                
                // Check for duplicate file names
                const existingFileNames = Object.keys(files);
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    if (existingFileNames.includes(file.name)) {
                        uploadStatus.innerHTML = `<div class="message error">Error: File "${file.name}" is already uploaded. Files must have different names.</div>`;
                        return;
                    }
                }
                
                // Limit to 3 files
                if (existingFileNames.length + uploadedFiles.length > 3) {
                    uploadStatus.innerHTML = `<div class="message warning">Maximum 3 files recommended. Please remove some files first.</div>`;
                    return;
                }
                
                uploadStatus.innerHTML = `<div class="message info">Reading files, please wait...</div>`;
                
                // Process each file
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    try {
                        const content = await readFileAsText(file);
                        const parsedData = parseCSV(content);
                        
                        if (!isValidParameterFile(parsedData)) {
                            uploadStatus.innerHTML = `<div class="message error">Error: "${file.name}" does not appear to be a valid parameter file. It should have columns for Parameter Name, Current Value, and Illustrate.</div>`;
                            return;
                        }
                        
                        // Create parameter map
                        const paramMap = {};
                        parsedData.data.forEach(row => {
                            if (!row['Parameter Name'] || row['Current Value'] === undefined) return;
                            
                            paramMap[row['Parameter Name']] = {
                                value: normalizeValue(row['Current Value']),
                                illustrate: row['Illustrate'] || ''
                            };
                        });
                        
                        // Store the file data
                        files[file.name] = {
                            paramMap,
                            displayName: file.name.replace('.csv', '')
                        };
                        
                        // Update UI
                        updateFileList();
                        updateAllParameters();
                    } catch (err) {
                        uploadStatus.innerHTML = `<div class="message error">Error reading ${file.name}: ${err.message}</div>`;
                    }
                }
                
                // Clear file input for re-uploads
                fileInput.value = '';
                uploadStatus.innerHTML = '';
                
                // Show comparison controls if we have at least 2 files
                if (Object.keys(files).length >= 2) {
                    comparisonContainer.classList.remove('hidden');
                    instructions.classList.add('hidden');
                    generateComparisonData();
                }
            }
            
            // Normalize numeric values to have 2 decimal places
            function normalizeValue(value) {
                if (value === undefined || value === null || value === '') return '';
                
                // Check if it's a number
                const num = parseFloat(value);
                if (!isNaN(num)) {
                    // Return with 2 decimal places, removing trailing zeros
                    return Number(num.toFixed(2)).toString();
                }
                
                // Return original value if not a number
                return value.toString().trim();
            }
            
            // Check if the parsed data appears to be a valid parameter file
            function isValidParameterFile(parsedData) {
                if (!parsedData.data || !parsedData.data.length) return false;
                
                // Check if the required columns exist
                const fields = Object.keys(parsedData.data[0]);
                return fields.includes('Parameter Name') && fields.includes('Current Value');
            }
            
            // Helper function to read file as text
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error("File reading failed"));
                    reader.readAsText(file);
                });
            }
            
            // Parse CSV data
            function parseCSV(csvText) {
                // Simple CSV parser
                const lines = csvText.split(/\r\n|\n/);
                const headers = lines[0].split(',').map(h => h.trim());
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = line.split(',');
                    const row = {};
                    
                    for (let j = 0; j < headers.length; j++) {
                        row[headers[j]] = values[j] ? values[j].trim() : '';
                    }
                    
                    data.push(row);
                }
                
                return { data, headers };
            }
            
            // Update the file list UI
            function updateFileList() {
                document.getElementById('uploaded-files').innerHTML = '';
                
                Object.keys(files).forEach(fileName => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    
                    fileItem.innerHTML = `
                        <div class="file-name">${fileName}</div>
                        <button class="file-remove" data-file="${fileName}">×</button>
                    `;
                    
                    document.getElementById('uploaded-files').appendChild(fileItem);
                });
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.file-remove').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const fileName = this.getAttribute('data-file');
                        delete files[fileName];
                        updateFileList();
                        updateAllParameters();
                        
                        // Hide comparison controls if we have fewer than 2 files
                        if (Object.keys(files).length < 2) {
                            comparisonContainer.classList.add('hidden');
                            instructions.classList.remove('hidden');
                        } else {
                            generateComparisonData();
                        }
                    });
                });
            }
            
            // Update the master list of all parameters
            function updateAllParameters() {
                const paramSet = new Set();
                
                Object.values(files).forEach(file => {
                    Object.keys(file.paramMap).forEach(param => {
                        paramSet.add(param);
                    });
                });
                
                allParameters = [...paramSet].sort();
                
                // Update stats
                if (totalParamsEl) {
                    totalParamsEl.textContent = allParameters.length;
                }
            }
            
            // Generate comparison data and update table
            function generateComparisonData() {
                if (Object.keys(files).length < 2 || !allParameters.length) {
                    comparisonData = [];
                    return;
                }
                
                const fileNames = Object.keys(files);
                
                comparisonData = allParameters.map(param => {
                    const paramData = {
                        parameterName: param,
                        hasDifferences: false,
                        values: {}
                    };
                    
                    // Store parameter values from each file
                    fileNames.forEach(fileName => {
                        const file = files[fileName];
                        paramData.values[file.displayName] = file.paramMap[param] || { value: 'N/A', illustrate: '' };
                    });
                    
                    // Check if there are differences in parameter values
                    const uniqueValues = new Set();
                    Object.values(paramData.values).forEach(v => uniqueValues.add(v.value));
                    paramData.hasDifferences = uniqueValues.size > 1;
                    
                    return paramData;
                });
                
                updateTable();
                updateStats();
            }
            
            // Update the parameter comparison table
            function updateTable() {
                // First, update the header row with file names
                const headerRow = comparisonTable.querySelector('thead tr');
                
                // Clear existing file columns
                const headerCells = headerRow.querySelectorAll('th');
                for (let i = headerCells.length - 2; i > 0; i--) {
                    headerRow.removeChild(headerCells[i]);
                }
                
                // Add file columns
                const fileDisplayNames = Object.values(files).map(f => f.displayName);
                const lastCell = headerRow.lastElementChild;
                fileDisplayNames.forEach(name => {
                    const th = document.createElement('th');
                    th.textContent = name;
                    headerRow.insertBefore(th, lastCell);
                });
                
                // Filter data if needed
                const filteredData = filterData();
                
                // Clear and rebuild tbody
                comparisonTbody.innerHTML = '';
                
                if (filteredData.length === 0) {
                    noResults.classList.remove('hidden');
                    return;
                }
                
                noResults.classList.add('hidden');
                
                // Add data rows
                filteredData.forEach(param => {
                    const row = document.createElement('tr');
                    if (param.hasDifferences) {
                        row.className = 'different-row';
                    }
                    
                    // Parameter name cell
                    const nameCell = document.createElement('td');
                    nameCell.className = 'parameter-name-cell';
                    nameCell.textContent = param.parameterName;
                    row.appendChild(nameCell);
                    
                    // Value cells for each file
                    fileDisplayNames.forEach(displayName => {
                        const valueCell = document.createElement('td');
                        const paramValue = param.values[displayName].value;
                        
                        valueCell.textContent = paramValue;
                        
                        // Highlight differences
                        if (param.hasDifferences) {
                            const otherValues = Object.entries(param.values)
                                .filter(([name]) => name !== displayName)
                                .map(([_, v]) => v.value);
                            
                            const isDifferent = otherValues.some(v => v !== paramValue && v !== 'N/A');
                            if (isDifferent) {
                                valueCell.className = 'different-value';
                            }
                        }
                        
                        row.appendChild(valueCell);
                    });
                    
                    // Illustrate cell (allowed values)
                    const illustrateCell = document.createElement('td');
                    illustrateCell.className = 'allowed-values-cell';
                    // Get illustrate value from the first file that has it
                    for (const displayName of fileDisplayNames) {
                        const illustrateValue = param.values[displayName].illustrate;
                        if (illustrateValue) {
                            illustrateCell.textContent = illustrateValue;
                            break;
                        }
                    }
                    row.appendChild(illustrateCell);
                    
                    comparisonTbody.appendChild(row);
                });
            }
            
            // Filter data based on user settings
            function filterData() {
                if (!comparisonData.length) return [];
                
                let filtered = [...comparisonData];
                
                // Filter for differences only
                if (showDifferences.checked) {
                    filtered = filtered.filter(item => item.hasDifferences);
                }
                
                // Filter by search term
                const search = searchParameter.value.toLowerCase();
                if (search) {
                    filtered = filtered.filter(item => 
                        item.parameterName.toLowerCase().includes(search)
                    );
                }
                
                return filtered;
            }
            
            // Handle filter changes
            function filterResults() {
                updateTable();
            }
            
            // Update statistics
            function updateStats() {
                if (!comparisonData.length) return;
                
                const totalParams = allParameters.length;
                const diffParams = comparisonData.filter(p => p.hasDifferences).length;
                const missingParams = comparisonData.filter(p => 
                    Object.values(p.values).some(v => v.value === 'N/A')
                ).length;
                
                totalParamsEl.textContent = totalParams;
                diffParamsEl.textContent = diffParams;
                missingParamsEl.textContent = missingParams;
            }
            
            // Reset everything
            function resetAll() {
                files = {};
                allParameters = [];
                comparisonData = [];
                document.getElementById('uploaded-files').innerHTML = '';
                uploadStatus.innerHTML = '';
                comparisonContainer.classList.add('hidden');
                instructions.classList.remove('hidden');
                showDifferences.checked = false;
                searchParameter.value = '';
            }
        });
    </script>
</body>
</html>